# 部署指南

<cite>
**本文档引用文件**  
- [logic-ide/pom.xml](file://logic-ide/pom.xml)
- [logic-runtime/pom.xml](file://logic-runtime/pom.xml)
- [logic-ide-service/pom.xml](file://logic-ide-service/pom.xml)
- [test-suite/src/main/resources/application.yaml](file://test-suite/src/main/resources/application.yaml)
- [test-suite/src/main/resources/application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml)
</cite>

## 目录
1. [简介](#简介)
2. [本地开发部署](#本地开发部署)
3. [生产环境部署](#生产环境部署)
4. [Kubernetes部署示例](#kubernetes部署示例)
5. [服务间网络连通性要求](#服务间网络连通性要求)
6. [常见部署问题排查](#常见部署问题排查)

## 简介
本部署指南旨在为`xuanwu-logic`项目提供完整的部署操作说明，涵盖本地开发环境与生产环境的配置流程。文档详细说明如何通过Maven打包生成可执行JAR文件，配置`application.yaml`中的数据库、缓存、日志存储等关键参数，并提供基于Kubernetes的部署最佳实践。同时，强调各服务实例间的网络通信要求（如`logic-ide`需访问`logic-runtime`），并附带常见问题的诊断与解决方案。

## 本地开发部署

### Maven打包生成可执行JAR
使用Maven对各模块进行编译和打包，生成独立可运行的JAR文件。以`logic-ide`模块为例：

```bash
cd logic-ide
./mvnw clean package -DskipTests
```

该命令将执行清理、编译、测试（跳过）和打包操作，最终在`target/`目录下生成类似`logic-ide-0.3.4-SNAPSHOT.jar`的可执行JAR文件。

其他核心模块（如`logic-runtime`、`logic-ide-service`）也遵循相同打包流程。

**Section sources**
- [logic-ide/pom.xml](file://logic-ide/pom.xml#L1-L103)
- [logic-runtime/pom.xml](file://logic-runtime/pom.xml#L1-L65)
- [logic-ide-service/pom.xml](file://logic-ide-service/pom.xml#L1-L63)

### 配置application.yaml
在本地开发环境中，需正确配置`application.yaml`文件以连接本地依赖服务。参考`test-suite`模块中的配置文件：

#### 数据库配置
```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/logic_test_0_9?useUnicode=true&characterEncoding=gbk&autoReconnect=true&failOverReadOnly=false
    username: root
    password: 12#$qwER
```

确保本地MySQL服务已启动，并创建对应数据库。

#### 缓存与日志存储配置
```yaml
logic:
  log:
    store: es
    item-queue-size: 30
    es:
      host: http://es.xuanwu-factory.dev.aimstek.cn
      index: logic-log-cbb-154
```

日志存储使用Elasticsearch，需确保ES服务可达。若本地无ES环境，可临时修改`store`为其他模式或启用内存模式（需代码支持）。

#### 其他关键配置
- `server.port`: 指定服务监听端口（如8888）
- `logic.config-dir`: 测试用例配置目录路径
- `scan-package-names`: 扫描包名，用于加载自定义组件

**Section sources**
- [test-suite/src/main/resources/application.yaml](file://test-suite/src/main/resources/application.yaml#L1-L48)

### 启动服务
打包完成后，使用以下命令启动服务：
```bash
java -jar target/logic-ide-*.jar
```

确保各依赖服务（MySQL、Redis、Elasticsearch）均已正常运行。

## 生产环境部署

生产环境部署需在本地构建的基础上，进行更严格的资源配置与安全设置。

### 构建优化
建议在CI/CD流水线中执行构建，避免本地环境差异：
```bash
./mvnw clean package -DskipTests -Pprod
```
若存在生产环境Profile（`prod`），应启用以加载特定配置。

### 配置管理
生产环境的`application.yaml`应从`application-k8s.yaml`获取灵感，关键变更包括：

#### 数据库连接
```yaml
spring:
  datasource:
    url: jdbc:mysql://prod-db.aimstek.cn:3306/logic_prod?useUnicode=true&characterEncoding=utf8&autoReconnect=true
    username: logic_user
    password: ${DB_PASSWORD} # 使用环境变量注入
```

使用专用数据库地址，并通过环境变量注入密码，避免明文暴露。

#### 日志存储索引命名
```yaml
logic:
  log:
    es:
      index: logic-log-prod
```

区分生产环境日志索引，便于监控与查询。

#### 缓存配置（Redis）
虽然当前配置未启用Redis，但可通过取消注释以下内容启用：
```yaml
# biz-lock:
#   type: redis
#   redis:
#     host: redis.prod.aimstek.cn
#     port: 6379
#     password: ${REDIS_PASSWORD}
```

**Section sources**
- [test-suite/src/main/resources/application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml#L1-L48)

## Kubernetes部署示例

参考`application-k8s.yaml`文件，结合Kubernetes资源清单实现高可用部署。

### 服务暴露
使用`NodePort`或`LoadBalancer`类型Service暴露服务：
```yaml
apiVersion: v1
kind: Service
metadata:
  name: logic-ide-service
spec:
  type: LoadBalancer
  ports:
    - port: 8888
      targetPort: 8888
      protocol: TCP
  selector:
    app: logic-ide
```

### 资源配置
在Deployment中设置合理的资源限制：
```yaml
resources:
  requests:
    memory: "2Gi"
    cpu: "500m"
  limits:
    memory: "4Gi"
    cpu: "1000m"
```

### 健康检查
配置Liveness和Readiness探针：
```yaml
livenessProbe:
  httpGet:
    path: /actuator/health
    port: 8888
  initialDelaySeconds: 60
  periodSeconds: 30

readinessProbe:
  httpGet:
    path: /actuator/health
    port: 8888
  initialDelaySeconds: 30
  periodSeconds: 10
```

确保应用启动完成后才接入流量。

### 配置注入
使用ConfigMap管理`application.yaml`，Secret管理敏感信息：
```bash
kubectl create configmap logic-config --from-file=application-k8s.yaml
kubectl create secret generic logic-secrets --from-literal=DB_PASSWORD=xxx --from-literal=REDIS_PASSWORD=yyy
```

**Section sources**
- [test-suite/src/main/resources/application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml#L1-L48)

## 服务间网络连通性要求

系统中多个服务需相互通信，必须确保网络策略允许相应端口通信。

### 核心通信需求
- **logic-ide → logic-runtime**: `logic-ide`模块在运行时需调用`logic-runtime`执行逻辑计算，确保`logic-runtime`服务可被`logic-ide`访问。
- **logic-ide-service → logic-ide**: `logic-ide-service`作为代理服务，需能访问`logic-ide`的内部API。
- **所有服务 → MySQL/Redis/ES**: 所有后端服务均需访问数据库、缓存和日志系统。

### Kubernetes网络策略示例
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-logic-ide-to-runtime
spec:
  podSelector:
    matchLabels:
      app: logic-runtime
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: logic-ide
    ports:
    - protocol: TCP
      port: 8888
```

确保服务间调用不会被网络策略阻断。

**Section sources**
- [logic-ide/pom.xml](file://logic-ide/pom.xml#L1-L103)
- [logic-runtime/pom.xml](file://logic-runtime/pom.xml#L1-L65)

## 常见部署问题排查

### 1. 数据库连接失败
**现象**：启动时报`Cannot acquire connection`错误。  
**排查步骤**：
- 检查`application.yaml`中数据库URL、用户名、密码是否正确
- 确认数据库服务是否运行且网络可达
- 检查防火墙或Kubernetes NetworkPolicy是否阻止连接

### 2. Elasticsearch日志写入失败
**现象**：日志无法写入ES，出现连接超时。  
**排查步骤**：
- 验证`es.host`配置是否正确
- 使用`curl`测试ES服务连通性：`curl http://es.xuanwu-factory.dev.aimstek.cn`
- 检查ES索引是否存在，是否有写入权限

### 3. Maven打包失败
**现象**：`mvnw package`报依赖下载失败。  
**解决方法**：
- 检查`pom.xml`中仓库地址：`https://nexus.aimstek.cn/repository/maven-public`
- 确保网络可访问公司镜像仓库
- 清理本地仓库缓存：`rm -rf ~/.m2/repository/com/aims/logic`

### 4. 服务启动后无法访问
**现象**：JAR运行无报错，但HTTP请求无响应。  
**排查步骤**：
- 检查`server.port`是否被占用
- 查看日志确认是否成功绑定端口
- 若在K8s中，检查Service与Pod的Selector是否匹配

### 5. Redis锁功能未生效
**现象**：分布式锁未起作用。  
**原因**：当前配置默认为`memory`模式。  
**解决**：在生产环境启用Redis模式并正确配置连接信息。

**Section sources**
- [test-suite/src/main/resources/application.yaml](file://test-suite/src/main/resources/application.yaml#L1-L48)
- [test-suite/src/main/resources/application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml#L1-L48)