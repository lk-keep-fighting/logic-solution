# 节点表单配置

<cite>
**本文档引用文件**  
- [java.json](file://logic-ide/src/main/resources/public/setting/node-form/java.json)
- [sub-logic.json](file://logic-ide/src/main/resources/public/setting/node-form/sub-logic.json)
- [LogicItemGroupDto.java](file://logic-ide/src/main/java/com/aims/logic/ide/controller/dto/LogicItemGroupDto.java)
- [MethodDto.java](file://logic-ide/src/main/java/com/aims/logic/ide/controller/dto/MethodDto.java)
- [node-form目录](file://logic-ide/src/main/resources/public/setting/node-form)
</cite>

## 目录

1. [引言](#引言)  
2. [节点表单配置文件结构](#节点表单配置文件结构)  
3. [核心字段语义解析](#核心字段语义解析)  
4. [前后端协同机制](#前后端协同机制)  
5. [自定义节点表单实践指南](#自定义节点表单实践指南)  
6. [结论](#结论)

## 引言

在逻辑编排系统中，节点是构成业务流程的基本单元。每个节点在画布上通过属性面板进行配置，而这些面板的结构与行为由JSON格式的配置文件定义。本文档聚焦于`node-form`目录下的节点表单配置机制，深入解析`java.json`、`sub-logic.json`等文件的设计原理与实现方式，阐明其如何驱动前端UI渲染，并与后端数据结构协同完成节点配置的持久化与加载。

## 节点表单配置文件结构

`node-form`目录位于`logic-ide/src/main/resources/public/setting/node-form`路径下，存放了各类节点类型的表单定义文件。这些文件采用JSON Schema风格的结构，描述了节点在编辑器中属性面板的布局与字段定义。

每个配置文件遵循统一的顶层结构：

```json
{
  "type": "object",
  "properties": { /* 字段定义 */ },
  "column": 1
}
```

- `type`：固定为`object`，表示该表单对应一个对象结构。
- `properties`：定义表单中包含的各个字段及其属性。
- `column`：指定表单字段的布局列数（1或2），影响UI展示的宽度与排列方式。

例如，`java.json`文件定义了Java调用节点的表单结构，包含名称、系统名、类路径、方法名及参数等字段；而`sub-logic.json`则用于子逻辑调用节点，包含调用逻辑编号、入参声明与返回值接收变量等配置项。

**Section sources**
- [java.json](file://logic-ide/src/main/resources/public/setting/node-form/java.json)
- [sub-logic.json](file://logic-ide/src/main/resources/public/setting/node-form/sub-logic.json)

## 核心字段语义解析

节点表单配置文件中的关键字段直接影响UI渲染与用户交互行为。以下是对主要字段的语义解析：

### icon 与 color（未显式出现在JSON中，但由系统映射）

尽管`icon`和`color`未直接出现在`node-form/*.json`文件中，它们通常由节点类型（如`java`、`sub-logic`）在前端注册时通过映射表关联。例如，`java`节点可能默认使用“代码”图标与蓝色背景，而`sub-logic`使用“流程”图标与绿色背景，用于在画布上区分节点类型。

### fields 与 properties

`properties`字段是表单的核心，定义了所有可配置项。每个字段包含以下语义属性：

- `title`：字段在UI中显示的标签名称，如“名称”、“完整类路径”。
- `type`：字段的数据类型，常见为`string`，也可为`number`、`boolean`等。
- `widget`：指定渲染组件类型，如：
  - `"textArea"`：多行文本输入框
  - `"js"`：JavaScript代码编辑器（支持语法高亮）
- `props`：传递给UI组件的额外属性，如`rows`、`height`，用于控制显示样式。
- `extra`：辅助说明文本，显示在字段下方，指导用户输入格式（如“js代码块，需return字符串”）。
- `defaultValue`：字段默认值（可选）。

例如，在`java.json`中，`body`字段使用`widget: "js"`并设置高度为200，提示用户输入返回参数数组的JS代码块，体现了动态脚本配置的能力。

### groups（分组逻辑）

虽然当前`node-form`中的JSON文件未显式使用`groups`字段进行分组，但在更复杂的表单中（如`forms/process-group.json`），可通过嵌套结构或`amis`框架的`collapse`组件实现“基础信息”、“参数配置”、“高级设置”等区域折叠面板。`node-form`的扁平化设计适用于字段较少的节点，保持简洁性。

**Section sources**
- [java.json](file://logic-ide/src/main/resources/public/setting/node-form/java.json)
- [sub-logic.json](file://logic-ide/src/main/resources/public/setting/node-form/sub-logic.json)

## 前后端协同机制

节点配置的完整生命周期涉及前端表单定义、用户输入、数据持久化及后端加载执行。其核心在于前后端数据结构的映射与同步。

### 后端数据结构支撑

前端配置最终需映射到后端可处理的数据模型。关键DTO类包括：

- `LogicItemGroupDto`：表示节点组信息，包含`name`（组名）、`shape`（形状）、`order`（顺序）等字段，用于组织节点分类与展示。
- `MethodDto`：封装方法元信息，包含`Method`反射对象与`MethodSourceCodeDto`源码信息，用于Java节点的方法调用解析。

这些DTO在控制器（如`LogicItemController`）中接收前端提交的JSON配置，并进行校验、转换与持久化存储。

### 配置持久化与加载流程

1. **前端提交**：用户在属性面板完成配置后，表单数据被序列化为JSON对象。
2. **后端接收**：`LogicItemController`接收包含节点配置的请求体，反序列化为`Map<String, Object>`或具体DTO。
3. **持久化**：配置数据与逻辑流程定义一同存储至数据库（如`LogicEntity`或`LogicBakEntity`）。
4. **加载渲染**：当用户打开逻辑流程时，后端读取配置JSON并返回前端，前端根据`node-form`中的Schema动态生成表单UI。

此机制实现了配置的灵活扩展：新增节点类型只需添加对应的`node-form/*.json`文件，并确保后端能正确解析其结构。

**Section sources**
- [LogicItemGroupDto.java](file://logic-ide/src/main/java/com/aims/logic/ide/controller/dto/LogicItemGroupDto.java)
- [MethodDto.java](file://logic-ide/src/main/java/com/aims/logic/ide/controller/dto/MethodDto.java)
- [java.json](file://logic-ide/src/main/resources/public/setting/node-form/java.json)
- [sub-logic.json](file://logic-ide/src/main/resources/public/setting/node-form/sub-logic.json)

## 自定义节点表单实践指南

### JSON结构规范

要新增自定义节点表单，需在`node-form`目录下创建新的JSON文件，命名与节点类型一致（如`custom-task.json`）。基本结构如下：

```json
{
  "type": "object",
  "properties": {
    "name": {
      "title": "名称",
      "type": "string",
      "widget": "textArea",
      "props": { "rows": 1 }
    },
    "config": {
      "title": "自定义配置",
      "type": "string",
      "widget": "js",
      "props": { "height": 150 },
      "extra": "请输入JS对象，如{ key: 'value' }"
    }
  },
  "column": 1
}
```

**规范要点**：
- 必须包含`name`字段用于节点命名。
- 使用`widget: "js"`支持动态脚本配置。
- `column`根据字段数量选择1或2列布局。

### 前端集成步骤

1. **创建配置文件**：在`logic-ide/src/main/resources/public/setting/node-form/`下新建`your-node-type.json`。
2. **注册节点类型**：在前端逻辑编辑器的节点注册模块中，添加新节点类型，并关联其图标、颜色与表单文件路径。
3. **重启服务**：重启IDE服务，使资源配置生效。
4. **验证功能**：在画布中添加新节点，检查属性面板是否正确渲染，配置能否正常保存与加载。

### 后端适配（如需）

若自定义节点需特殊处理，应在后端实现对应的`LogicItemFunctionRunner`（如继承`JavaCodeFunction`），并在`FunctionServiceLocator`中注册，确保运行时能正确执行。

**Section sources**
- [java.json](file://logic-ide/src/main/resources/public/setting/node-form/java.json)
- [sub-logic.json](file://logic-ide/src/main/resources/public/setting/node-form/sub-logic.json)

## 结论

`node-form`目录下的JSON配置文件是实现节点属性面板动态化的核心机制。通过标准化的Schema定义，系统实现了表单结构与UI渲染的解耦，支持快速扩展新节点类型。`icon`、`color`、`fields`、`groups`等概念虽部分隐式实现，但其设计思想贯穿于前后端协作中。结合`LogicItemGroupDto`、`MethodDto`等后端数据结构，系统完成了配置的持久化闭环。开发者可依据本文指南，高效实现自定义节点的表单配置与集成。