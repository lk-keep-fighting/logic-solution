# 部署配置

<cite>
**本文档引用文件**  
- [application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml)
- [application-dev.yaml](file://test-suite/src/main/resources/application-dev.yaml)
- [application.yaml](file://test-suite/src/main/resources/application.yaml)
- [env.dev.json](file://logic-sdk/logic-configs/envs/env.dev.json)
- [env.test.json](file://logic-sdk/logic-configs/envs/env.test.json)
- [index.json](file://logic-sdk/logic-configs/envs/index.json)
- [RuntimeUtil.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/util/RuntimeUtil.java)
- [LogicAppConfig.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/env/LogicAppConfig.java)
- [LogicSysEnvDto.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/env/LogicSysEnvDto.java)
</cite>

## 目录
1. [环境配置概述](#环境配置概述)
2. [开发与生产环境配置差异](#开发与生产环境配置差异)
3. [Kubernetes部署配置详解](#kubernetes部署配置详解)
4. [Docker镜像构建与环境变量](#docker镜像构建与环境变量)
5. [多环境配置管理最佳实践](#多环境配置管理最佳实践)

## 环境配置概述

本系统采用多环境配置管理模式，通过不同的配置文件实现开发、测试和生产环境的隔离。系统支持通过配置文件和环境变量两种方式管理配置，确保在不同部署场景下的灵活性和安全性。

**Section sources**
- [application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml)
- [application-dev.yaml](file://test-suite/src/main/resources/application-dev.yaml)
- [LogicSysEnvDto.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/env/LogicSysEnvDto.java)

## 开发与生产环境配置差异

### 数据库连接配置
开发环境与生产环境在数据库连接配置上存在显著差异：

- **开发环境**：使用本地MySQL数据库，连接URL为 `jdbc:mysql://localhost:3306/logic_dev`，便于本地开发和调试
- **生产环境**：连接到远程Kubernetes集群中的MySQL服务，URL为 `jdbc:mysql://dev.aimstek.cn:32150/logic_test_0_9`，确保生产数据的安全性和稳定性

### 日志存储策略
日志存储配置体现了环境间的不同需求：

- **开发环境**：日志存储设置为 `db`，将执行日志保存在数据库中，便于开发人员查看和调试
- **生产环境**：日志存储设置为 `es`，使用Elasticsearch作为日志存储后端，提供高性能的日志查询和分析能力

### 配置文件路径
系统通过 `config-dir` 参数指定配置文件的根目录，不同环境使用不同的配置路径：

- 开发环境配置目录：`/Users/lk/Documents/Dev/aims/xuanwu-logic/logic-solution/test-suite/configs/dev`
- 生产环境配置目录：`/Users/lk/Documents/Dev/aims/xuanwu-logic/logic-solution/test-suite/test-case-configs`

**Section sources**
- [application-dev.yaml](file://test-suite/src/main/resources/application-dev.yaml#L1-L43)
- [application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml#L1-L47)
- [RuntimeUtil.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/util/RuntimeUtil.java#L142-L173)

## Kubernetes部署配置详解

### Pod配置
Pod配置确保了应用在Kubernetes环境中的稳定运行：

- **资源限制**：通过requests和limits设置CPU和内存资源，防止资源过度消耗
- **健康检查**：配置liveness和readiness探针，确保Pod的健康状态和流量接入时机
- **环境变量**：通过envFrom引用ConfigMap，将配置注入到容器中

### Service配置
Service配置实现了服务发现和网络访问：

- **服务类型**：使用ClusterIP类型，为Pod提供稳定的内部访问地址
- **端口映射**：将容器端口8888映射到Service端口，确保外部流量正确路由
- **选择器**：通过标签选择器关联到相应的Pod

### Deployment配置
Deployment配置管理应用的部署和更新：

- **副本数**：设置适当的副本数，确保服务的高可用性
- **更新策略**：配置滚动更新策略，实现无缝的应用升级
- **Pod模板**：定义Pod的容器、卷和环境变量配置

### ConfigMap配置
ConfigMap用于管理非机密的配置数据：

- **应用配置**：存储application.yaml中的通用配置
- **环境特定配置**：通过不同的ConfigMap文件管理各环境的特有配置
- **配置热更新**：支持在不重启Pod的情况下更新配置

**Section sources**
- [application-k8s.yaml](file://test-suite/src/main/resources/application-k8s.yaml)
- [LogicAppConfig.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/env/LogicAppConfig.java)

## Docker镜像构建与环境变量

### Docker镜像构建参数
Dockerfile配置遵循最佳实践：

```dockerfile
FROM openjdk:17-jdk-slim

COPY target/logic-solution-*.jar app.jar
COPY logic-configs ./logic-configs

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

构建参数说明：
- 基础镜像使用openjdk:17-jdk-slim，确保Java 17运行环境
- 将打包后的JAR文件和配置目录复制到镜像中
- 暴露8080端口，与应用配置保持一致
- 使用ENTRYPOINT而非CMD，确保容器启动时执行正确的命令

### 环境变量设置
系统通过多种方式支持环境变量配置：

- **文件配置**：通过env.dev.json、env.test.json等文件管理环境变量
- **运行时注入**：支持通过Kubernetes的envFrom机制注入环境变量
- **动态加载**：运行时通过RuntimeUtil类读取和合并环境变量

关键环境变量包括：
- `NODE_ENV`：标识当前运行环境（dev、test、prod等）
- `LOGIC_CONFIG_MODEL`：配置模式（online或offline）
- `KEEP_BIZ_VERSION`：业务实例版本保持策略
- `DEFAULT_TRAN_SCOPE`：默认事务范围

**Section sources**
- [Dockerfile](file://readme.md#L111-L120)
- [env.dev.json](file://logic-sdk/logic-configs/envs/env.dev.json)
- [RuntimeUtil.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/util/RuntimeUtil.java)

## 多环境配置管理最佳实践

### 配置隔离策略
实施严格的配置隔离，确保环境间的独立性：

- **目录分离**：为不同环境创建独立的配置目录
- **文件命名**：使用环境标识作为配置文件名的一部分（如env.dev.json）
- **索引文件**：通过index.json文件管理当前激活的环境

### 敏感信息管理
采用安全的敏感信息处理方式：

- **环境变量**：将密码、密钥等敏感信息通过环境变量注入
- **配置加密**：对配置文件中的敏感数据进行加密存储
- **访问控制**：限制对配置文件的访问权限，仅授权人员可修改

### 动态配置加载
实现灵活的动态配置机制：

- **运行时读取**：应用启动时从指定目录读取环境配置
- **配置缓存**：使用内存缓存提高配置读取性能
- **热更新支持**：支持在不重启应用的情况下更新部分配置

### 配置版本控制
建立完善的配置版本管理体系：

- **Git版本控制**：将配置文件纳入Git管理，记录变更历史
- **环境同步**：确保各环境配置的同步和一致性
- **回滚机制**：支持配置的快速回滚，降低变更风险

**Section sources**
- [index.json](file://logic-sdk/logic-configs/envs/index.json)
- [LogicSysEnvDto.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/env/LogicSysEnvDto.java)
- [RuntimeUtil.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/util/RuntimeUtil.java)