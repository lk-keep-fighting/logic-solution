# 节点执行机制

<cite>
**本文档引用文件**  
- [LogicItemRunner.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/LogicItemRunner.java)
- [FunctionContext.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/FunctionContext.java)
- [LogicItemLog.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/contract/logger/LogicItemLog.java)
- [Functions.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/Functions.java)
- [JsFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JsFunction.java)
</cite>

## 目录
1. [简介](#简介)
2. [核心执行流程](#核心执行流程)
3. [节点类型处理机制](#节点类型处理机制)
4. [执行上下文作用](#执行上下文作用)
5. [节点执行日志记录](#节点执行日志记录)
6. [代码示例说明](#代码示例说明)

## 简介
本文档详细阐述LogicItemRunner的节点执行机制，重点分析其如何处理不同类型的逻辑节点，包括JavaScript代码执行、等待节点超时处理、全局与局部变量赋值等核心功能。通过深入解析执行流程、上下文管理和日志记录机制，全面揭示系统运行原理。

## 核心执行流程

```mermaid
flowchart TD
Start([开始执行节点]) --> ValidateContext["验证执行上下文"]
ValidateContext --> GetItemType["获取节点类型"]
GetItemType --> BeginLog["记录开始时间"]
BeginLog --> SwitchType{"判断节点类型"}
SwitchType --> |"js"| ExecuteJS["执行JavaScript代码"]
SwitchType --> |"wait"| HandleWait["处理等待节点"]
SwitchType --> |"assign-global"| AssignGlobal["赋值全局变量"]
SwitchType --> |"assign-local"| AssignLocal["赋值局部变量"]
SwitchType --> |"end"| ExecuteEnd["执行结束节点"]
SwitchType --> |"其他"| DefaultHandle["默认处理"]
ExecuteJS --> CompleteNode
HandleWait --> CompleteNode
AssignGlobal --> CompleteNode
AssignLocal --> CompleteNode
ExecuteEnd --> CompleteNode
DefaultHandle --> CompleteNode
CompleteNode --> RecordResult["记录返回值"]
RecordResult --> CheckLogOff{"是否关闭日志?"}
CheckLogOff --> |是| SkipLog["跳过日志记录"]
CheckLogOff --> |否| EndLog["记录结束时间和结果"]
EndLog --> ReturnResult["返回执行结果"]
SkipLog --> ReturnResult
style ExecuteJS fill:#4CAF50,stroke:#388E3C
style HandleWait fill:#2196F3,stroke:#1976D2
style AssignGlobal fill:#FF9800,stroke:#F57C00
style AssignLocal fill:#FF9800,stroke:#F57C00
```

**图示来源**  
- [LogicItemRunner.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/LogicItemRunner.java#L18-L90)

## 节点类型处理机制

### JavaScript节点执行
当节点类型为"js"时，系统通过Functions.get("js")获取JavaScript执行器，并调用其invoke方法执行脚本内容。该过程利用GraalVM引擎在安全沙箱中运行JavaScript代码，确保执行的安全性和隔离性。

### 等待节点超时处理
对于"wait"类型节点，系统首先解析配置的超时表达式，通过Functions.runJsByContext在当前上下文中计算实际等待时间。若超时值大于0，则调用Thread.sleep进行阻塞等待，期间捕获可能的InterruptedException异常并记录错误信息。

### 全局变量赋值实现
"assign-global"类型节点通过构造特定格式的JavaScript语句（_global.varName = value）来实现全局变量赋值。执行后立即查询赋值结果，确保变量已正确设置，并将最新值作为返回数据。

### 局部变量赋值实现
"assign-local"类型节点采用类似机制，通过执行"_var.varName = value"语句完成局部变量赋值。与全局变量不同，局部变量存储在FunctionContext的_var对象中，具有更短的作用域生命周期。

**本节来源**  
- [LogicItemRunner.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/LogicItemRunner.java#L18-L90)
- [Functions.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/Functions.java#L22-L23)

## 执行上下文作用

```mermaid
classDiagram
class FunctionContext {
+Map<String, Object> _par
+JSONObject _var
+JSONObject _env
+JSONObject _global
+LogicItemRunResult _last
+String logicId
+String bizId
+LogicItemTreeNode nextItem
+get_lastRet() Object
+set_lastRet(Object) void
+isLogOff() boolean
+getTranScope() LogicItemTransactionScope
}
class LogicItemRunner {
+LogicItemTreeNode dsl
+LogicItemRunResult run(FunctionContext)
}
class JsFunction {
+Engine sharedEngine
+LogicItemRunResult invoke(FunctionContext, Object)
}
FunctionContext --> LogicItemRunner : "作为参数传递"
FunctionContext --> JsFunction : "提供执行环境"
JsFunction --> FunctionContext : "更新变量状态"
```

**图示来源**  
- [FunctionContext.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/FunctionContext.java#L0-L104)
- [LogicItemRunner.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/LogicItemRunner.java#L14-L16)

执行上下文（FunctionContext）在节点执行过程中扮演核心角色，主要功能包括：
- 维护参数集合（_par）、局部变量（_var）、环境变量（_env）和全局变量（_global）
- 跟踪当前逻辑ID（logicId）和业务ID（bizId）
- 存储上一个节点的执行结果（_last）
- 管理事务作用域和传播属性
- 控制日志开关状态（isLogOff方法）

## 节点执行日志记录

```mermaid
sequenceDiagram
participant LIR as LogicItemRunner
participant CTX as FunctionContext
participant LOG as LogicItemLog
LIR->>LIR : 创建LogicItemLog实例
LIR->>LIR : 设置节点名称
LIR->>LOG : 记录开始时间
LIR->>LIR : 执行switch分支逻辑
LIR->>LIR : 处理特定节点类型
LIR->>LIR : 获取执行结果
LIR->>LOG : 设置结束时间
LIR->>LOG : 设置配置信息
LIR->>LOG : 设置返回数据
LIR->>LOG : 设置成功状态
LIR->>LIR : 检查日志开关
alt 日志未关闭
LIR->>CTX : 添加日志到逻辑日志
end
LIR->>LIR : 返回包含日志的结果
```

**图示来源**  
- [LogicItemRunner.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/LogicItemRunner.java#L18-L90)
- [LogicItemLog.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/contract/logger/LogicItemLog.java#L0-L53)

节点执行日志（LogicItemLog）记录过程包含以下关键步骤：
1. 在节点执行开始时创建LogicItemLog实例并设置名称
2. 记录执行开始时间（setBeginTime）
3. 执行完节点逻辑后记录结束时间（setEndTime）
4. 保存节点配置信息（config）和转换后的实例（configInstance）
5. 存储返回数据（setReturnData）和执行消息（msg）
6. 标记执行成功状态（success）
7. 根据上下文的日志开关状态决定是否最终记录日志

## 代码示例说明

### JavaScript节点配置示例
```json
{
  "type": "js",
  "script": "return _par.inputValue * 2;"
}
```
此配置将输入参数inputValue乘以2后返回，展示了JavaScript节点的基本用法。

### 等待节点配置示例
```json
{
  "type": "wait",
  "timeout": "1000 + Math.random() * 1000"
}
```
该配置实现1-2秒之间的随机等待，timeout字段支持JavaScript表达式计算。

### 全局变量赋值示例
```json
{
  "type": "assign-global",
  "url": "counter",
  "body": "(_global.counter || 0) + 1"
}
```
此配置实现全局计数器递增，每次执行都将counter值加1。

### 局部变量赋值示例
```json
{
  "type": "assign-local",
  "url": "tempResult",
  "body": "_par.valueA + _par.valueB"
}
```
该配置将两个输入参数相加并存储到局部变量tempResult中。

**本节来源**  
- [LogicItemRunner.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/LogicItemRunner.java#L38-L62)
- [JsFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JsFunction.java#L19-L146)