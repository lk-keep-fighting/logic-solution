# 核心功能

<cite>
**本文档引用的文件**  
- [readme.md](file://readme.md)
- [HttpFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/HttpFunction.java)
- [JavaCodeFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JavaCodeFunction.java)
- [JsFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JsFunction.java)
- [SwitchFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/SwitchFunction.java)
- [SubLogicFunction.java](file://logic-sdk/src/main/java/com/aims/logic/sdk/functions/SubLogicFunction.java)
- [LogicRunnerService.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/service/LogicRunnerService.java)
- [LogicItemTransactionScope.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/contract/enums/LogicItemTransactionScope.java)
- [LogicRunModelEnum.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/contract/dto/LogicRunModelEnum.java)
- [LogicLogEntity.java](file://logic-sdk/src/main/java/com/aims/logic/sdk/entity/LogicLogEntity.java)
</cite>

## 目录
1. [可视化编排与节点类型](#可视化编排与节点类型)
2. [有状态与无状态执行模式](#有状态与无状态执行模式)
3. [断点调试与日志追踪](#断点调试与日志追踪)
4. [事务边界控制](#事务边界控制)
5. [业务实例生命周期管理](#业务实例生命周期管理)
6. [节点实现原理与组合应用](#节点实现原理与组合应用)

## 可视化编排与节点类型

系统提供基于拖拽式界面的可视化流程设计能力，支持多种功能节点的灵活组合，实现复杂业务逻辑的图形化编排。核心节点类型包括：

- **条件判断节点（Switch）**：基于表达式结果进行流程分支控制。
- **HTTP调用节点（Http）**：发起外部HTTP请求，支持自定义方法、URL、头信息与超时设置。
- **Java代码执行节点（Java）**：调用指定类中的方法，支持强类型参数映射与反射执行。
- **JavaScript执行节点（Js）**：在GraalVM引擎中执行JS脚本，实现轻量级逻辑处理。
- **子逻辑调用节点（Sub-Logic）**：嵌套调用其他逻辑流程，支持同步与异步模式。

这些节点通过DSL（领域特定语言）结构在流程中定义，并由对应的函数执行器（`ILogicItemFunctionRunner`）驱动。

**Section sources**
- [SwitchFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/SwitchFunction.java#L15-L64)
- [HttpFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/HttpFunction.java#L22-L117)
- [JavaCodeFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JavaCodeFunction.java#L21-L180)
- [JsFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JsFunction.java#L19-L146)
- [SubLogicFunction.java](file://logic-sdk/src/main/java/com/aims/logic/sdk/functions/SubLogicFunction.java#L17-L132)

## 有状态与无状态执行模式

系统支持两种核心执行模式，以适应不同业务场景的需求。

### 无状态执行模式
适用于瞬时任务，每次调用独立，不保留执行上下文。通过 `runByMap` 方法触发，传入逻辑ID与参数即可执行。

```java
LogicRunResult result = logicService.runByMap("my-logic-id", params);
```

### 有状态执行模式
适用于长周期、可中断的业务流程。通过 `runBizByMap` 方法创建或恢复业务实例，系统会持久化实例的执行状态（如当前节点、变量、参数等），支持后续从断点继续执行。

```java
// 首次执行，创建业务实例
LogicRunResult result = logicService.runBizByMap("workflow-id", "biz-001", params);

// 后续调用，从断点继续
LogicRunResult nextResult = logicService.runBizByMap("workflow-id", "biz-001", newParams);
```

该模式为复杂业务自动化提供了流程可恢复、状态可追踪的能力。

**Section sources**
- [readme.md](file://readme.md#L56-L131)
- [LogicRunnerService.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/service/LogicRunnerService.java#L12-L287)

## 断点调试与日志追踪

系统提供完整的执行日志记录与可视化调试能力。每次执行（无论有状态或无状态）都会生成详细的日志条目，存储于 `logic_log` 表中，关键字段包括：

- `bizId`：业务实例标识，用于关联有状态流程。
- `paramsJson`：输入参数快照。
- `varsJson` / `varsJsonEnd`：执行前后的局部变量状态。
- `itemLogs`：各节点执行详情，包含耗时、输入输出、错误信息。
- `isOver`：流程是否结束。
- `success`：执行是否成功。
- `message`：异常或中断信息。

开发者可通过日志系统追溯任意实例的完整执行路径，定位问题节点，实现精准调试。

**Section sources**
- [LogicLogEntity.java](file://logic-sdk/src/main/java/com/aims/logic/sdk/entity/LogicLogEntity.java#L12-L51)
- [LogicRunnerService.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/service/LogicRunnerService.java#L12-L287)

## 事务边界控制

系统提供灵活的事务传播机制，允许在流程级别或节点级别定义事务边界。通过 `LogicItemTransactionScope` 枚举支持多种事务模式：

- `off`：关闭事务。
- `def`：使用默认事务配置。
- `everyRequest`：每次请求开启一个事务（默认）。
- `everyNode`：每个节点执行后提交事务，异常则中断。
- `everyNode2`：每个节点执行后提交事务，仅业务异常类不中断。

此机制确保了在复杂流程中，数据一致性与业务灵活性的平衡，开发者可根据业务关键性选择合适的事务粒度。

**Section sources**
- [LogicItemTransactionScope.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/contract/enums/LogicItemTransactionScope.java#L4-L26)
- [LogicRunModelEnum.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/contract/dto/LogicRunModelEnum.java#L2-L13)

## 业务实例生命周期管理

系统对有状态业务实例提供全生命周期管理能力，通过 `LogicRunnerService` 接口暴露以下核心操作：

- **创建与执行**：`runBizByMap` 创建并启动实例。
- **继续执行**：使用相同 `bizId` 调用 `runBizByMap` 恢复流程。
- **强制停止**：`forceStopBiz` 终止指定实例的执行。
- **强制完成**：`forceCompleteBiz` 将实例标记为完成。
- **重试异常实例**：`retryErrorBiz` 自动恢复因异常中断的实例。
- **更新参数**：`updateBizInstanceParams` 动态修改实例入参。
- **重置断点**：`resetBizInstanceNextId` 手动调整实例的下一个执行节点。
- **实例清理**：`deleteBizInstance` 和 `clearCompletedInstance` 用于清理过期实例。

这些功能共同构成了一个健壮的业务实例管理框架，支撑复杂业务场景下的可靠运行。

**Section sources**
- [LogicRunnerService.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/service/LogicRunnerService.java#L12-L287)

## 节点实现原理与组合应用

### 节点执行原理
所有节点均实现 `ILogicItemFunctionRunner` 接口，其核心方法 `invoke` 接收 `FunctionContext`（执行上下文）和节点DSL，返回 `LogicItemRunResult`。

- **HttpFunction**：使用OkHttpClient发起请求，动态解析URL、方法、头信息和请求体（通过JS表达式计算）。
- **JavaCodeFunction**：利用反射机制加载类、查找方法，并根据参数声明进行类型转换后执行。
- **JsFunction**：在GraalVM引擎中创建隔离的JS上下文，注入 `_var`, `_par`, `_env` 等上下文变量后执行脚本。
- **SwitchFunction**：计算条件表达式，匹配分支并返回下一节点ID。
- **SubLogicFunction**：创建新的 `LogicRunnerService` 实例，递归调用目标逻辑，支持父子流程间上下文传递。

### 组合应用示例
一个典型的订单处理流程可能包含：
1. **开始节点**：接收订单数据。
2. **Java节点**：调用库存服务校验库存。
3. **条件节点**：判断库存是否充足。
4. **HTTP节点**（是分支）：调用支付网关。
5. **子逻辑节点**（是分支）：调用发货逻辑。
6. **结束节点**：流程完成。

通过这种组合，平台能够将分散的服务能力编织成一个连贯、可靠、可追溯的自动化业务流，充分体现了其在复杂业务自动化中的灵活性与可靠性。

**Section sources**
- [HttpFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/HttpFunction.java#L22-L117)
- [JavaCodeFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JavaCodeFunction.java#L21-L180)
- [JsFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/JsFunction.java#L19-L146)
- [SwitchFunction.java](file://logic-runtime/src/main/java/com/aims/logic/runtime/runner/functions/impl/SwitchFunction.java#L15-L64)
- [SubLogicFunction.java](file://logic-sdk/src/main/java/com/aims/logic/sdk/functions/SubLogicFunction.java#L17-L132)
- [readme.md](file://readme.md#L56-L131)