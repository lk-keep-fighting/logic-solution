"use strict";(self.webpackChunkxuanwu_logic_web_design=self.webpackChunkxuanwu_logic_web_design||[]).push([[7853],{3070:function(wt,_,i){i.r(_),i.d(_,{default:function(){return bt}});var ue=i(54306),H=i.n(ue),ve=i(57213),C=i.n(ve),ge=i(93525),fe=i.n(ge),he=i(21140),me=i.n(he),pe=i(63466),ye=i.n(pe),xe=i(68608),E=i.n(xe),Se=i(58853),Ce=i.n(Se),be=i(38888),Ne=i.n(be),je=i(52510),A=i.n(je),Le=i(22465),Fe=i(14990),Te=i(72237),Ee=i(11150),$=i(5671),Ae=i(9722),Pe=i(17696),De=i(19227),ze=i(75476),ke=i(1167),we=i(22046),Oe=i(22150),Ze=i(11250),B=i(43702),G=i(58856),ee=i(40767),M=i(75904),Ie=i(29830),Z=i(87363),U=i.n(Z),Be=i(77357),Ge=i(5981),Je=i(32125),We=i(97944),Me=i(97563),Re=i(18725),l=i(33130);function He(r){var n=[{key:"sharps-panel",label:(0,l.jsx)(Ge.Z,{style:{fontSize:"20px",marginTop:10}}),children:(0,l.jsx)("div",{ref:r.refStencil,style:{margin:0,height:"100vh",width:"100%"}})},{key:"logic",label:(0,l.jsx)(Je.Z,{style:{fontSize:"20px",marginTop:10}}),children:(0,l.jsxs)("div",{style:{margin:0,height:"100vh"},children:[(0,l.jsx)(Me.Z,{title:"\u7528\u4E8E\u89E3\u6790\u6267\u884C\u7F16\u6392\u7684\u903B\u8F91\u3002",children:(0,l.jsx)("h3",{children:"Logic DSL"})}),(0,l.jsx)(We.ZP,{defaultLanguage:"json",options:{lineNumbers:"off",lineDecorationsWidth:0,minimap:{enabled:!1}},value:JSON.stringify(r.logic),onChange:r.onConfigChange})]})}];return(0,l.jsx)(Re.Z,{tabPosition:"left",style:{margin:0},items:n,tabBarStyle:{width:50,margin:0}})}var Ye=He,Ke=i(55104),$e=i(70256),te=function(r){var n,s=(0,Z.useState)({type:"form"}),u=H()(s,2),e=u[0],a=u[1],g=(0,Z.useState)({}),j=H()(g,2),m=j[0],x=j[1],h=r.configSchemaProvider,c=function(f){var S,y,o;(S=r.editNode)===null||S===void 0||S.setAttrByPath("text/text",f.name);var v=(y=r.editNode)===null||y===void 0?void 0:y.data.config;r.editNode&&(console.log("update graph data",f),r.editNode.setData({config:C()(C()({},v),f)},{overwrite:!0})),console.log("submit---props.editNode.data.config"),console.log((o=r.editNode)===null||o===void 0?void 0:o.data.config),r==null||r.onSubmit()},d=function(f){if(f&&f.data){var S,y=f.data.config||{},o=f.attrs;return y.name=o==null||(S=o.text)===null||S===void 0?void 0:S.text,y}else return{name:""}};return(0,Z.useEffect)(function(){if(r.editNode&&r.editNode.data){var t=r.editNode.data.config||{};(0,$e.CD)(r.editNode.data.configSchema||t.type).then(function(f){console.log("nodeConfigSchema"),console.log(f),a(f)})}},[r.editNode]),(0,Z.useEffect)(function(){var t,f,S=((t=r.editNode)===null||t===void 0?void 0:t.data.config)||{},y=C()({},S),o=(f=r.editNode)===null||f===void 0?void 0:f.attrs;o&&o.text&&o.text.text&&(y.name=o.text.text),x(y)},[e,(n=r.editNode)===null||n===void 0?void 0:n.data]),(0,l.jsx)(Ke.Z,{config:e,values:C()({},m),onSubmit:c})};function Ue(r){var n=[{key:"1",label:"\u8282\u70B9\u914D\u7F6E",children:(0,l.jsx)("div",{style:{padding:5},children:(0,l.jsx)(te,{editNode:r.editNode,onSubmit:r.onSubmit})})}];return(0,l.jsxs)("div",{style:{margin:0,height:"95vh",overflowY:"scroll"},children:[(0,l.jsx)(te,{logic:r.logic,editNode:r.editNode,onSubmit:r.onSubmit}),r!=null&&r.isCollapsed?"":(0,l.jsx)(M.ZP,{type:"text",style:{position:"absolute",top:10,right:15,fontSize:20,textAlign:"center"},onClick:function(){r==null||r.onClose()},children:"x"})]})}var Ve=Ue,D={groups:{top:{position:"top",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},right:{position:"right",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}},zIndex:1},bottom:{position:"bottom",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},left:{position:"left",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}}},items:[{group:"top"},{group:"right"},{group:"bottom"},{group:"left"}]},Ot={groups:{right:{position:"right",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}},zIndex:1}},items:[{group:"right"}]},Zt={groups:{bottom:{position:"bottom",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}},zIndex:1}},items:[{group:"bottom"}]},It=50,Xe=50,Qe=[{name:"ExtSharp",config:{width:100,height:Xe,attrs:{body:{rx:6,ry:6,stroke:"#5F95FF",strokeWidth:1,fill:"rgba(95,149,255,0.05)",refWidth:1,refHeight:1},image:{refX:2,refY:0},text:{refX:4,refY:20,fontSize:12,"text-anchor":"start"}},markup:[{tagName:"rect",selector:"body"},{tagName:"image",selector:"image"},{tagName:"text",selector:"label"}]}}];function qe(r,n,s){var u=80,e=80,a={body:{fill:"#fff",stroke:"#8f8f8f",strokeWidth:1}},g=[{shape:"circle",width:60,height:60,attrs:{body:C()(C()({},a.body),{},{fill:"white"}),text:{text:"\u52A0\u5DE5\u5DE5\u5E8F"}},markup:[{tagName:"circle",selector:"body"},{tagName:"text",selector:"label"}],ports:D,data:{config:{type:"process",processType:"\u52A0\u5DE5\u5DE5\u5E8F"}},groups:["process"]},{shape:"path",x:40,y:40,width:u,height:60,path:"M3,45 C1.9,45 1,44.2 1,43.1 L29,2.9 C30.1,1.3 31.3,1 32.1,1 L32.1,1 C32.1,1 33.8,1.1 35.1,2.9 L63,43.1 C63,44.1 62.1,45 61,45 L3,45 L3,45 Z",attrs:{body:C()(C()({},a.body),{},{fill:"white"}),text:{text:"\u9759\u7F6E\u5DE5\u5E8F",refY:50}},ports:D,data:{config:{type:"process",processType:"\u9759\u7F6E\u5DE5\u5E8F"}},groups:["process"]},{shape:"polygon",x:600,y:70,width:u,height:e,points:"0,10 10,0 20,10 10,20",attrs:{body:C()({},a.body),text:{text:"\u68C0\u9A8C\u5DE5\u5E8F"}},ports:D,data:{config:{type:"process"}},groups:["process"]},{shape:"path",x:40,y:40,width:u,height:60,path:"M3,1 C1.9,1 1,1.8 1,2.9 L29,43.1 C30.1,44.7 31.3,45 32.1,45 L32.1,45 C32.1,45 33.8,44.9 35.1,43.1 L63,2.9 C63,1.9 62.1,1 61,1 L3,1 L3,1 Z",attrs:{body:C()(C()({},a.body),{},{fill:"white"}),text:{text:"\u914D\u6599\u5DE5\u5E8F",refY:10}},ports:D,data:{config:{type:"process"}},groups:["process"]},{x:40,y:40,width:100,height:50,ports:D,attrs:{body:C()(C()({},a.body),{},{stroke:"black",strokeWidth:1,fillOpacity:0}),text:{text:"\u5E76\u884C\u5DE5\u5E8F\u7EC4",refY:10}},data:{config:{type:"process"}},groups:["process"]},{x:40,y:40,width:100,height:50,ports:D,attrs:{body:C()(C()({},a.body),{},{strokeDasharray:"5,5",stroke:"black",strokeWidth:2,fillOpacity:0}),text:{text:"\u5E73\u884C\u5DE5\u5E8F\u7EC4",refY:10}},data:{config:{type:"process"}},groups:["process"]}];r&&r.length>0&&Array.prototype.push.apply(g,r);var j=[{name:"process",title:"\u5DE5\u5E8F",graphHeight:800}];n&&n.length>0&&Array.prototype.push.apply(j,n);var m=Qe;return s&&s.length>0&&Array.prototype.push.apply(m,s),{Shapes:m,Nodes:g,Groups:j}}var R=i(95812),V=i(54882),Y={customNode:"customNode___sd76A",input:"input___Io7w3",switchNode:"switchNode___wB22H"},_e=function(n){return(0,l.jsx)("div",{className:Y.customNode,children:(0,l.jsx)(V.Z,{className:"input",value:n==null?void 0:n.data,width:80})})},et=i(42761),tt=function(n){return(0,l.jsx)("div",{className:styles.customNode,children:(0,l.jsx)(et.Z,{className:"input",value:n==null?void 0:n.data,width:80})})},ot=function(n){var s,u,e,a=n.node,g=(s=a.data.config)===null||s===void 0?void 0:s.name,j=g||"case";return(0,l.jsxs)("div",{className:Y.customNode,children:[(0,l.jsx)("span",{children:"case"}),(0,l.jsx)(V.Z,{addonAfter:g,className:"input",value:a==null||(u=a.data)===null||u===void 0||(e=u.config)===null||e===void 0?void 0:e.case,width:150,onChange:function(x){var h=a.data;a.setData(C()(C()({},h),{},{config:C()(C()({},h.config),{},{case:x.target.value})}))}})]})},nt=function(n){var s,u=n.node;return(0,l.jsx)("div",{className:Y.customNode,children:(0,l.jsx)(V.Z,{addonBefore:"switch",className:"input",value:(s=u.data)===null||s===void 0?void 0:s.config.condition,onChange:function(a){var g=u.data;u.setData(C()(C()({},g),{},{config:C()(C()({},g.config),{},{condition:a.target.value})}))},width:100})})},it=function(n){return(0,l.jsx)("div",{className:Y.customNode,children:(0,l.jsx)("div",{style:{textAlign:"center",fontSize:"15px"},children:"default"})})};function at(r){r.forEach(function(n){console.log("\u6CE8\u518C\u65B0\u8282\u70B9:"+n.name),$.kJ.registerNode(n.name,n.config,!0)}),(0,R.z2)({shape:"string",component:_e}),(0,R.z2)({shape:"num",component:tt}),(0,R.z2)({shape:"switch",component:nt}),(0,R.z2)({shape:"switch-case",component:ot}),(0,R.z2)({shape:"switch-default",component:it})}function Bt(r){}var rt=(0,Z.forwardRef)(function(r,n){return(0,l.jsx)("div",{className:"drag-graph",ref:n})}),st=rt,lt=function(n,s){var u,e,a,g,j=s.getData(),m=s.getPosition(),x=n.getNodes(),h;if(["ExtSharp","polygon"].indexOf(s.shape)>-1)switch(j.config.type){case"switch":var c=200,d=n.addNode({shape:"switch",position:m,width:c,height:50,ports:D,data:s.data,attrs:{body:{stroke:"#8f8f8f",strokeWidth:1,fill:"#fff",rx:6,ry:6}}});n.removeNode(s);var t=n.addNode({shape:"switch-case",position:{y:m.y+100,x:m.x-c/2},width:120,height:50,ports:D,data:{config:{type:"switch-case"}}}),f=n.addNode({shape:"switch-default",position:{y:m.y+100,x:m.x+c},width:120,height:50,ports:D,data:{config:{type:"switch-default"}}}),S=n.addEdge({source:d,sourcePort:(u=d.ports.items.find(function(k){return k.group=="bottom"}))===null||u===void 0?void 0:u.id,target:t,targetPort:(e=t.ports.items.find(function(k){return k.group=="top"}))===null||e===void 0?void 0:e.id,zIndex:0}),y=n.addEdge({source:d,sourcePort:(a=d.ports.items.find(function(k){return k.group=="bottom"}))===null||a===void 0?void 0:a.id,target:f,targetPort:(g=f.ports.items.find(function(k){return k.group=="top"}))===null||g===void 0?void 0:g.id,zIndex:0});h=d;break;case"switch-case":var o=n.createNode({shape:"switch-case",position:s.position(),width:120,height:50,ports:D,data:s.data});n.removeNode(s),n.addNode(o),h=o;break;case"string":var v=n.createNode({shape:"string",position:s.position(),width:100,height:50,ports:D,data:s.data});n.removeNode(s),n.addNode(v),h=v;break;case"num":var p=n.createNode({shape:"num",position:s.position(),width:100,height:50,ports:D,data:s.data});n.removeNode(s),n.addNode(p),h=p;break;case"assignment":var N=n.createNode({shape:"assignment",position:s.position(),width:220,height:50,ports:D,data:s.data});n.removeNode(s),n.addNode(N),h=N;break;default:break}if(["\u5E76\u884C\u5DE5\u5E8F\u7EC4","\u5E73\u884C\u5DE5\u5E8F\u7EC4"].indexOf(s.getAttrByPath("text/text"))>-1&&(s.zIndex=-1,s.setAttrByPath("text/text","")),console.log("node:added"),h&&x.length==1){var L,z,I,J,P;n.addEdge({source:x[0],sourcePort:(L=x[0].ports.items.find(function(k){return k.group=="bottom"}))===null||L===void 0?void 0:L.id,target:h,targetPort:(z=h)===null||z===void 0||(I=z.ports)===null||I===void 0||(J=I.items)===null||J===void 0||(P=J.find(function(k){return k.group=="top"}))===null||P===void 0?void 0:P.id,zIndex:0})}},dt=i(59490),ct=function(n){var s=new dt.Vq({type:"dagre",begin:[400,100],rankdir:"TB",ranksep:20,nodeSize:80,controlPoints:!0}),u=n.getNodes(),e=n.getEdges(),a=s.layout({nodes:u,edges:e}),g=a.nodes,j=g===void 0?[]:g;u.forEach(function(m){var x=j.find(function(h){return h.id===m.id});x.x-=m.size().width/2,x.y-=m.size().height/2,m.position(x.x,x.y)})},K=i(94744),X=i(72107),ut=i(5726),vt=i.n(ut),gt=i(71731),ft=[{key:"saveToPng",label:"\u5BFC\u51FA\u56FE\u7247"},{key:"saveToClipboard",label:"\u590D\u5236\u5230\u526A\u8D34\u677F"}],ht=U().createContext({logic:new X.Iz("")}),oe=function(n,s){for(var u=0,e=n.length;u<e;u+=1)n[u].style.visibility=s?"visible":"hidden"},mt=function(r){Ce()(s,r);var n=Ne()(s);function s(u){var e;me()(this,s),e=n.call(this,u),A()(E()(e),"container",void 0),A()(E()(e),"stencilContainer",void 0),A()(E()(e),"state",{editingNode:void 0,openEdgeEditor:!1,embeddingEnable:!1,editingEdge:void 0,leftToolCollapsed:!1,rightToolCollapsed:!0,openFlowSetting:!1,openRunLogic:!1,editorCtx:{logic:new X.Iz("1")},logs:[],panel:{nodes:[],groups:[]}}),A()(E()(e),"handleEdgeSubmit",function(c){var d;(d=e.state.editingEdge)===null||d===void 0||d.setLabels(c)}),A()(E()(e),"initGraph",function(c){var d,t=new $.kJ({container:c,embedding:{enabled:!0,findParent:function(v){var p=v.node,N=p.getBBox();return this.getNodes().filter(function(L){var z=L.getData();if(z&&z.parent){var I=L.getBBox();return N.isIntersectWithRect(I)}return!1})}},mousewheel:{enabled:!0,modifiers:"ctrl",minScale:.5,maxScale:3},connecting:{router:"manhattan",connector:{name:"rounded",args:{radius:15}},anchor:"center",connectionPoint:"anchor",allowBlank:!1,allowMulti:!0,snap:{radius:20},createEdge:function(){return new $.bn.kS({tools:[{name:"edge-editor",args:{attrs:{backgroundColor:"#fff"}}}],zIndex:0})},validateConnection:function(v){var p=v.targetMagnet;return!!p}},background:{color:"#F2F7FA"},grid:!0});t.use(new ke.H({enabled:!0,sharp:!0})).use(new Pe.A({enabled:!0})).use(new ze.Y({enabled:!0,multiple:!0,strict:!0,rubberband:!0,movable:!0,showNodeSelectionBox:!0,pointerEvents:"none"})).use(new Oe.T({enabled:!0})).use(new De.N).use(new Ae.T).use(new Ze.D).use(new gt.w({resizing:{enabled:!0,minWidth:50,maxWidth:0,minHeight:50,maxHeight:0,orthogonal:!1,restrict:!1,preserveAspectRatio:!1}})),t.on("edge:dblclick",function(o){var v=o.cell}),t.on("edge:mouseenter",function(o){var v=o.cell;v.addTools([])}),t.on("edge:mouseleave",function(o){var v=o.cell}),t.on("node:mouseenter",function(o){var v,p,N,L=o.cell;((v=L.data)===null||v===void 0||(p=v.config)===null||p===void 0?void 0:p.type)!="start"&&L.addTools([{name:"button-remove",args:{x:"100%",y:0,offset:{x:-10,y:10}}}]);var z=(N=e.container)===null||N===void 0?void 0:N.querySelectorAll(".x6-port-body");oe(z,!0)}),t.on("node:mouseleave",function(o){var v,p=o.cell;p.removeTools();var N=(v=e.container)===null||v===void 0?void 0:v.querySelectorAll(".x6-port-body");oe(N,!1)}),t.on("node:click",function(o){var v=o.e,p=o.x,N=o.y,L=o.node,z=o.view;L.removeTools(),e.setState({editingNode:L})}),t.on("node:added",function(o){var v=o.node,p=o.index,N=o.options;lt(t,v)}),t.on("node:dblclick",function(o){var v=o.e,p=o.x,N=o.y,L=o.node,z=o.view;e.setState({rightToolCollapsed:!1,editingNode:L})}),t.bindKey(["meta+c","ctrl+c"],function(){var o=t.getSelectedCells();return o.length&&t.copy(o),!1}),t.bindKey(["meta+x","ctrl+x"],function(){var o=t.getSelectedCells();return o.length&&t.cut(o),!1}),t.bindKey(["meta+v","ctrl+v"],function(){if(!t.isClipboardEmpty()){var o=t.paste({offset:32});t.cleanSelection(),t.select(o)}return!1}),t.bindKey(["meta+z","ctrl+z"],function(){return t.canUndo()&&t.undo(),!1}),t.bindKey(["meta+shift+z","ctrl+shift+z"],function(){return t.canRedo()&&t.redo(),!1}),t.bindKey("backspace",function(){var o=t.getSelectedCells();o.length&&(o.find(function(v){var p;return v.data?["start"].indexOf((p=v.data.config)===null||p===void 0?void 0:p.type)>-1:!1})?B.ZP.error("\u7981\u6B62\u5220\u9664\u5F00\u59CB\u8282\u70B9\uFF01"):t.removeCells(o))}),t.on("blank:dblclick",function(o){var v=o.e,p=o.x,N=o.y;console.log("blank:dbclick",p,N),e.autoLayout(t)}),t.bindKey(["ctrl+1","meta+1"],function(){var o=t.zoom();o<1.5&&t.zoom(.1)}),t.bindKey(["ctrl+2","meta+2"],function(){var o=t.zoom();o>.5&&t.zoom(-.1)}),e.state.graph=t;var f=e.state.panel.groups,S=new we.t({title:"\u5C55\u5F00/\u6536\u8D77",target:t,search:function(v,p){var N=v.getAttrByPath("text/text");return(N==null?void 0:N.indexOf(p))!==-1},notFoundText:"\u672A\u627E\u5230",collapsable:!0,stencilGraphWidth:250,groups:f,layoutOptions:{rowHeight:100}}),y={};return e.state.panel.nodes.forEach(function(o){var v=t.createNode(o);f.forEach(function(p){o.groups.includes(p.name)&&(y[p.name]?y[p.name].push(v):y[p.name]=[v])})}),Object.keys(y).forEach(function(o){S.load(fe()(y[o]),o)}),(d=e.stencilContainer)===null||d===void 0||d.appendChild(S.container),e.props.config?(e.state.editorCtx.logic=e.props.config,t.fromJSON(e.state.editorCtx.logic.visualConfig)):e.autoLayout(t),t}),A()(E()(e),"autoLayout",function(c){ct(c)}),A()(E()(e),"refContainer",function(c){e.container=c}),A()(E()(e),"refStencil",function(c){e.stencilContainer=c}),A()(E()(e),"handleSubmit",function(c){e.saveAndConvertGraphToDsl()}),A()(E()(e),"handleOnConfigChange",function(c){try{var d=JSON.parse(c);e.setState({stepFlow:d})}catch(t){console.log(t)}}),A()(E()(e),"onSaveMenuClick",function(c){var d;switch(c.key){case"saveToBrowser":break;case"loadFromBrowser":var t=localStorage.getItem("logic-json");if(t){var f,S=JSON.parse(t);e.state.editorCtx.logic=S,(f=e.state.graph)===null||f===void 0||f.fromJSON(S.visualConfig),e.saveAndConvertGraphToDsl()}else B.ZP.info("\u6D4F\u89C8\u5668\u65E0\u7F13\u5B58\u6570\u636E");break;case"saveToClipboard":try{navigator.clipboard.writeText(JSON.stringify(e.state.editorCtx.logic))}catch(y){console.error(y)}break;case"saveToPng":(d=e.state.graph)===null||d===void 0||d.exportPNG(new Date().toLocaleDateString(),{backgroundColor:"#F2F7FA",padding:10,quality:1});break}}),A()(E()(e),"updateLogicAndEditorCtx",function(c){var d=C()(C()({},e.state.editorCtx.logic),c);return d.version=vt()(Date.now()).format("YYYYMMDDHHmmss"),e.setState({editorCtx:C()(C()({},e.state.editorCtx),{},{logic:d})}),d}),A()(E()(e),"saveAndConvertGraphToDsl",function(){var c,d=(c=e.state.graph)===null||c===void 0?void 0:c.toJSON(),t=e.convertGraphToDsl(d);if(t){var f=e.updateLogicAndEditorCtx({items:t.items,visualConfig:t.visualConfig});if(e.props.config){var S;f.id=(S=e.props.config)===null||S===void 0?void 0:S.id}e.props.onSave&&e.props.onSave(f);var y=JSON.stringify(f);localStorage.setItem("logic-"+f.name,y)}}),A()(E()(e),"saveFlowSettingAndConvertGraphToDsl",function(c){var d,t,f,S,y=K.y.getParamArrayByJson(JSON.parse((d=c.params)!==null&&d!==void 0?d:"{}")),o=K.y.getReturnArrayByJson(JSON.parse((t=c.returns)!==null&&t!==void 0?t:"{}")),v=K.y.getVariableArrayByJson(JSON.parse((f=c.variables)!==null&&f!==void 0?f:"{}")),p=K.y.getEnvsArrayByJson(JSON.parse((S=c.envs)!==null&&S!==void 0?S:"{}")),N=e.updateLogicAndEditorCtx({params:y,returns:o,variables:v,envs:p}),L=JSON.stringify(N);localStorage.setItem("logic-json-"+N.id,L)}),A()(E()(e),"convertGraphToDsl",function(c){var d,t=(0,Be.zI)((d=e.props.config)===null||d===void 0?void 0:d.id,c.cells);return t&&(t.visualConfig=c),t}),A()(E()(e),"setFlowSetting",function(c){e.setState({openFlowSetting:c})});try{var a,g,j=qe(u.customNodes,u.customGroups,u.customSharps),m=j.Nodes,x=j.Shapes,h=j.Groups;at(x),e.state.leftToolCollapsed=!(!((a=u.showLeft)!==null&&a!==void 0)||a),e.state.rightToolCollapsed=!((g=u.showRight)!==null&&g!==void 0&&g),e.state.panel.nodes=m,e.state.panel.groups=h}catch(c){console.error("\u6CE8\u518C\u8282\u70B9\u51FA\u9519\uFF1A"),console.error(c)}return e}return ye()(s,[{key:"componentDidUpdate",value:function(e,a,g){if(this.props.config&&this.state.editorCtx.logic.id!=this.props.config.id){var j,m,x,h;this.state.editorCtx.logic=this.props.config,(j=this.state.editorCtx)!==null&&j!==void 0&&(m=j.logic)!==null&&m!==void 0&&m.visualConfig&&((x=this.state.graph)===null||x===void 0||x.fromJSON((h=this.state.editorCtx.logic)===null||h===void 0?void 0:h.visualConfig)),this.setState({editingNode:void 0})}}},{key:"componentDidMount",value:function(){var e;this.initGraph(this.container),this.updateLogicAndEditorCtx((e=this.state.editorCtx)===null||e===void 0?void 0:e.logic)}},{key:"render",value:function(){var e=this,a,g=this.state,j=g.editingNode,m=g.leftToolCollapsed,x=g.rightToolCollapsed,h=g.editorCtx,c=g.embeddingEnable,d=g.graph,t=g.openFlowSetting,f=g.openRunLogic,S=h.logic;return console.log("editorCtx",h),(0,l.jsx)(ht.Provider,{value:h,children:(0,l.jsxs)(G.Z,{style:{height:"100vh",width:"100%",margin:0},children:[(0,l.jsx)(G.Z.Sider,{theme:"light",collapsed:m,collapsedWidth:0,width:300,children:(0,l.jsx)(Ye,{refStencil:this.refStencil,graph:this.state.graph,logic:S,onConfigChange:this.handleOnConfigChange})}),(0,l.jsxs)(G.Z,{style:{height:"100%"},children:[(0,l.jsxs)(G.Z.Header,{style:{padding:0,backgroundColor:"white"},children:[(0,l.jsxs)(ee.Z,{direction:"horizontal",children:[(0,l.jsx)(M.ZP,{type:"text",icon:m?(0,l.jsx)(Le.Z,{}):(0,l.jsx)(Fe.Z,{}),onClick:function(){e.setState({leftToolCollapsed:!m})},style:{fontSize:"16px",width:64,height:64}}),(0,l.jsx)(Ie.Z.Button,{style:{float:"inline-start"},menu:{items:ft,onClick:this.onSaveMenuClick},buttonsRender:function(o){return[(0,l.jsx)(M.ZP,{type:"primary",icon:(0,l.jsx)(Te.Z,{}),onClick:e.saveAndConvertGraphToDsl,children:"\u4FDD\u5B58"}),(0,l.jsx)(M.ZP,{type:"primary",icon:(0,l.jsx)(Ee.Z,{})})]},children:"\u4FDD\u5B58"}),(a=this.props.btns)===null||a===void 0?void 0:a.map(function(y){return y}),(0,l.jsxs)("span",{children:["\u5F53\u524D\u7248\u672C:",S.version]})]}),(0,l.jsx)(ee.Z,{style:{float:"right",right:"16px"}})]}),(0,l.jsx)(G.Z.Content,{className:"app-content",children:(0,l.jsx)(st,{ref:this.refContainer})})]}),(0,l.jsx)(G.Z.Sider,{theme:"light",collapsed:x,collapsedWidth:0,width:600,children:(0,l.jsx)(Ve,{logic:S,onClear:function(){return e.setState({logs:[]})},editNode:j,onSubmit:this.handleSubmit,logs:this.state.logs,onClose:function(){e.setState({rightToolCollapsed:!0})},isCollapsed:x})})]})})}}]),s}(U().Component),Gt=i(10486),Jt=i(14232),Wt=i(37555),Mt=i(59998),Rt=i(88287),Ht=i(23620),Yt=U().createContext({logic:new X.Iz("")}),Kt=function(n){var s,u=useState(),e=_slicedToArray(u,2),a=e[0],g=e[1],j=useState(),m=_slicedToArray(j,2),x=m[0],h=m[1],c=useState(!1),d=_slicedToArray(c,2),t=d[0],f=d[1],S=useState(!0),y=_slicedToArray(S,2),o=y[0],v=y[1],p=useState(),N=_slicedToArray(p,2),L=N[0],z=N[1],I=useState(),J=_slicedToArray(I,2),P=J[0],k=J[1],Nt=useState(),ie=_slicedToArray(Nt,2),Q=ie[0],jt=ie[1],Lt=useState(),ae=_slicedToArray(Lt,2),Ft=ae[0],re=ae[1],Tt=useState(),se=_slicedToArray(Tt,2),Et=se[0],At=se[1],le=useRef(),de=function(O){var T=O.node;re(T);var b=P==null?void 0:P.itemLogs.find(function(w){return w.config.id==T.id});z(b)};useEffect(function(){Q&&(a==null||a.centerCell(Q))},[Q,a]),useEffect(function(){console.log("play curItemLog",L)},[L]),useEffect(function(){var F=a==null?void 0:a.getNodes().find(function(O){return O.id==n.nextId});F==null||F.attr("body/fill","red"),jt(F)},[n.nextId]),useEffect(function(){var F;a==null||(F=a.getNodes().find(function(O){return O.id==n.nextId}))===null||F===void 0||F.attr("body/fill","red")},[a]),useEffect(function(){n.config&&h(n.config)},[n.config]),useEffect(function(){var F,O;console.log("props.debugLogs",n.debugLogs),((F=n.debugLogs)===null||F===void 0?void 0:F.length)>0&&setInterval(Pt,2e3);var T=[];n&&((O=n.debugLogs)===null||O===void 0||O.forEach(function(b){var w,W;T.push({children:_jsx(_Fragment,{children:_jsxs("span",{style:{cursor:"pointer",fontWeight:b.id==(P==null?void 0:P.id)?"bolder":"normal",color:b.id==(P==null?void 0:P.id)?"#52c41a":"black"},onClick:function(){k(b),console.log(b),a==null||a.fromJSON(x==null?void 0:x.visualConfig);var ce;b.itemLogs.forEach(function(zt){var q=a==null?void 0:a.getNodes().find(function(kt){return kt.id==zt.config.id});q&&(q.attr("body/fill","#52c41a"),ce=q)}),a==null||a.centerCell(ce),z({}),re({})},children:[_jsx("p",{children:(w=b.itemLogs[0])===null||w===void 0?void 0:w.config.name}),((W=n.logicIns)===null||W===void 0?void 0:W.version)==b.version?_jsx("p",{}):_jsx("p",{children:_jsxs(Space,{children:[_jsx(Typography.Paragraph,{style:{color:"red"},children:"\u7248\u672C\u53F7:"}),_jsxs(Typography.Paragraph,{copyable:{tooltips:["\u70B9\u51FB\u590D\u5236","\u590D\u5236\u6210\u529F!"],text:b.version},children:[b.version,_jsx(Typography.Link,{style:{margin:"5px"},href:"#/assets/logic/i/".concat(b.logicId,"/view/").concat(b.version),target:"_blank",children:_jsx(ApartmentOutlined,{})})]})]})}),_jsxs("p",{children:["\u4E1A\u52A1\u6807\u8BC6\uFF1A",b.bizId]}),_jsx("p",{children:b.serverTime}),_jsx("p",{children:b.message})]})}),color:b.success?"green":"red"})})),At(T)},[n.debugLogs,n.logicIns,a,P]),useEffect(function(){if(x){try{var F=InitPanelData(),O=F.Shapes;RegistShape(O)}catch(b){console.error("\u6CE8\u518C\u8282\u70B9\u51FA\u9519\uFF1A"),console.error(b)}var T=new Graph({container:le.current,embedding:{enabled:!0,validate:function(w){return w.child.setData({hoverNode:w.parent}),!0}},mousewheel:{enabled:!0,modifiers:"ctrl",minScale:.5,maxScale:3},connecting:{router:"manhattan",connector:{name:"rounded",args:{radius:15}},anchor:"center",connectionPoint:"anchor",allowBlank:!1,allowMulti:!0,snap:{radius:20},createEdge:function(){return new Shape.Edge({tools:[{name:"edge-editor",args:{attrs:{backgroundColor:"#fff"}}}],zIndex:0})},validateConnection:function(w){var W=w.targetMagnet;return!!W}},highlighting:{magnetAdsorbed:{name:"stroke",args:{attrs:{fill:"#5F95FF",stroke:"#5F95FF"}}}},background:{color:"#F2F7FA"},grid:!0});T.use(new Snapline({enabled:!0,sharp:!0})).use(new History({enabled:!0})).use(new Selection({enabled:!0,multiple:!0,strict:!0,rubberband:!0,movable:!0,showNodeSelectionBox:!0,pointerEvents:"none"})).use(new Scroller({enabled:!0})).use(new Keyboard),T.on("edge:dblclick",function(){}),T.on("edge:mouseenter",function(){}),T.on("edge:mouseleave",function(){}),T.on("node:moved",function(){}),T.on("node:mouseenter",function(){}),T.on("node:mouseleave",function(){}),T.on("node:added",function(){}),T.on("node:dblclick",function(b){var w=b.node;v(!1)}),T.on("blank:dblclick",function(b){var w=b.x,W=b.y}),T.fromJSON(x.visualConfig),autoDagreLayout(T),g(T)}},[x]),useEffect(function(){a==null||a.off("node:click",de),a==null||a.on("node:click",de)},[P]);var Pt=function(){},Dt=[{key:"1",label:"\u65E5\u5FD7",children:_jsx(JsonView,{src:L})},{key:"2",label:"\u8282\u70B9\u914D\u7F6E",children:_jsx(NodeData,{editNode:Ft,configSchemaProvider:n.configSchemaProvider})}];return _jsxs(Layout,{style:{margin:0,height:"100vh"},children:[_jsxs(Layout.Sider,{theme:"light",collapsedWidth:0,width:300,style:{overflow:"auto",height:"100vh",position:"fixed",left:0,top:0,bottom:0,borderRight:"0.5px solid"},children:[_jsx(Divider,{children:"\u6700\u8FD1\u8BF7\u6C42"}),_jsx(Timeline,{style:{height:"100%"},items:Et})]}),_jsxs(Layout,{style:{marginLeft:300},children:[_jsxs(Layout.Header,{style:{backgroundColor:"white",padding:0},children:[_jsxs(Space,{direction:"horizontal",style:{},children:[_jsx(Divider,{type:"vertical"}),(s=n.btns)===null||s===void 0?void 0:s.map(function(F){return F})]}),_jsx(Button,{type:"text",icon:o?_jsx(MenuFoldOutlined,{}):_jsx(MenuUnfoldOutlined,{}),onClick:function(){v(!o)},style:{float:"right",right:"16px",fontSize:"16px",width:64,height:64}})]}),_jsx(Layout.Content,{className:"app-content",children:_jsx(DagreGraph,{ref:le})})]}),_jsxs(Layout.Sider,{theme:"light",collapsed:o,collapsedWidth:0,style:{overflow:"scroll"},title:"ddd",width:500,children:[_jsx(Button,{type:"text",onClick:function(){v(!o)},style:{float:"right",fontSize:"16px",width:64,height:64},children:"x"}),_jsx(Tabs,{items:Dt,defaultActiveKey:"1"})]})]})},$t=null,pt=i(52615),yt=i(98306),ne=i(48364),xt=i(70517),St=i(99273),Ct=function(){var n=(0,yt.UO)(),s=n.id,u=(0,Z.useState)(),e=H()(u,2),a=e[0],g=e[1],j=(0,Z.useState)(!1),m=H()(j,2),x=m[0],h=m[1],c=(0,Z.useCallback)(function(d){d.id=s,h(!0),g(d),(0,ne.az)(d.id,d.version,JSON.stringify(d)).then(function(t){h(!1),B.ZP.success("\u4FDD\u5B58\u6210\u529F"),console.log("save logic"),console.log(d)}).catch(function(t){h(!1),console.log("err"),console.log(t),B.ZP.error("\u4FDD\u5B58\u5931\u8D25")})},[]);return(0,Z.useEffect)(function(){h(!0),(0,ne.YH)(s).then(function(d){var t=d;t.id=s,g(t),h(!1)}).catch(function(d){h(!1),console.log("err"),console.log(d)})},[]),(0,l.jsx)("div",{children:(0,l.jsx)(pt.Z,{spinning:x,children:(0,l.jsx)(mt,{btns:[(0,l.jsx)(M.ZP,{onClick:function(){xt.Z.post("/api/mes/asm-system/bbs/v1/common/accounts/employee/access-token",{loginName:"admin",password:"1234@qwer"}).then(function(t){debugger;St.F.setTokenToLocal(t.data.data.accessToken),B.ZP.success(t.data.data.accessToken)}).catch(function(t){return B.ZP.error(t.toString())})},children:"\u83B7\u53D6\u6743\u9650"})],config:a,onSave:c})})})},bt=Ct}}]);
