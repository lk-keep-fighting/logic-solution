"use strict";(self.webpackChunkxuanwu_logic_web_design=self.webpackChunkxuanwu_logic_web_design||[]).push([[7853],{88287:function(pt,Ze,o){o.d(Ze,{Z:function(){return a}});var ze=o(57213),oe=o.n(ze),Re=o(85772),S=o(87363),Me=o.n(S),m=o(63466),ct=o(21140),Le=o(52510),We=o(54306),Ne=o.n(We),be=o(97944),De=o(47533),c=o(75904),Ie=o(47503),Pe=o(84191),He=o(49425),ve=o(94744),_=o(33130),vt=null,Ke=function(J){var N=(0,be.Ik)(),ue=(0,S.useContext)(De.r),A=ue.logic;(0,S.useEffect)(function(){if(A){var G,W,D,Ge,Xe=ve.y.getJsonByParams((G=A.variables)!==null&&G!==void 0?G:[]),Qe=(0,Pe.k)("_var",Xe),qe=ve.y.getJsonByParams((W=A.params)!==null&&W!==void 0?W:[]),_e=(0,Pe.k)("_par",qe),et=ve.y.getJsonByParams((D=A.returns)!==null&&D!==void 0?D:[]),tt=(0,Pe.k)("_ret",et),ot=ve.y.getJsonByParams((Ge=A.envs)!==null&&Ge!==void 0?Ge:[]),Je=(0,Pe.k)("_env",ot);N==null||N.languages.typescript.javascriptDefaults.addExtraLib(Qe,"var.ts"),N==null||N.languages.typescript.javascriptDefaults.addExtraLib(_e,"input.ts"),N==null||N.languages.typescript.javascriptDefaults.addExtraLib(tt,"return.ts"),N==null||N.languages.typescript.javascriptDefaults.addExtraLib(Je,"env.ts"),N==null||N.languages.typescript.javascriptDefaults.addExtraLib("let _lastRet:{}","lastRet.ts")}return function(){var ke;console.log("effect dispose"),N==null||(ke=N.current)===null||ke===void 0||ke.dispose()}},[A==null?void 0:A.params,A==null?void 0:A.variables,A==null?void 0:A.returns,A==null?void 0:A.envs]);var he=(0,S.useState)(!1),ie=Ne()(he,2),M=ie[0],$=ie[1];return(0,_.jsx)("div",{style:{width:"100%"},children:M?(0,_.jsx)(Ie.Z,{title:"js\u7F16\u8F91\u5668",centered:!0,width:1200,bodyStyle:{height:"80vh"},open:M,footer:null,onCancel:function(){return $(!1)},children:(0,_.jsx)(be.ML,oe()(oe()({theme:"vs-dark",defaultValue:J.value,defaultLanguage:J.language,options:{minimap:{enabled:!1}}},J),{},{height:"100%"}))}):(0,_.jsxs)("div",{children:[(0,_.jsx)(be.ML,oe()({className:"editorByLoader",theme:"vs-dark",defaultValue:J.value,defaultLanguage:J.language,onMount:function(W){var D;(D=W.getAction("editor.action.formatDocument"))===null||D===void 0||D.run(),W.setValue(W.getValue())},options:{minimap:{enabled:!1}},height:500},J)),(0,_.jsx)(c.ZP,{size:"small",type:"text",icon:(0,_.jsx)(He.Z,{}),style:{position:"absolute",top:0,right:0,margin:"10px",color:"whitesmoke"},onClick:function(){return $(!0)}})]})})},Be=Me().memo(Ke),ft=null,$e=function(J){return(0,_.jsx)(Be,oe()(oe()({},J),{},{language:"json"}))},Ve=$e,ht=null,de=function(J){return(0,_.jsx)(Be,oe()(oe()({},J),{},{language:"javascript"}))},fe=de,Fe=o(16414),le=function(J){return(0,S.useEffect)(function(){be._m.config({monaco:Fe})},[]),(0,_.jsx)(Re.ZP,oe()({widgets:{json:Ve,js:fe}},J))},Ue=le,Ye=le||Ue,a=function(y){var J,N=(0,Re.cI)(),ue=y.configSchemaProvider,A=function(M){var $,G,W;($=y.editNode)===null||$===void 0||$.setAttrByPath("text/text",M.name);var D=(G=y.editNode)===null||G===void 0?void 0:G.data.config;y.editNode&&y.editNode.setData({config:oe()(oe()({},D),M)}),console.log("submit---props.editNode.data.config"),console.log((W=y.editNode)===null||W===void 0?void 0:W.data.config),y==null||y.onSubmit()},he=function(M){if(M&&M.data){var $,G=M.data.config||{},W=M.attrs;return G.name=W==null||($=W.text)===null||$===void 0?void 0:$.text,G}else return{name:""}};return(0,S.useEffect)(function(){if(y.editNode&&y.editNode.data){var ie=y.editNode.data.config||{};ue(y.editNode.data.configSchema||ie.type).then(function(M){var $,G=y.editNode.attrs;ie.name=G==null||($=G.text)===null||$===void 0?void 0:$.text,console.log("nodeConfigSchema"),console.log(M),N.setSchema(M,!0),N.resetFields(),N.setValues(ie)})}},[y.editNode,(J=y.editNode)===null||J===void 0?void 0:J.data]),(0,_.jsx)("div",{children:(0,_.jsx)(Ye,{form:N,onFinish:A,onReset:function(){var M=he(y.editNode);N.setValues(M)},footer:!!y.onSubmit})})}},73489:function(pt,Ze,o){o.r(Ze),o.d(Ze,{default:function(){return zt}});var ze=o(93525),oe=o.n(ze),Re=o(54306),S=o.n(Re),Me=o(57213),m=o.n(Me),ct=o(63466),Le=o.n(ct),We=o(21140),Ne=o.n(We),be=o(52510),De=o.n(be),c=o(87363),Ie=o.n(c),Pe=o(22465),He=o(14990),ve=o(5671),_=o(9722),vt=o(17696),Ke=o(19227),Be=o(75476),ft=o(1167),$e=o(22046),Ve=o(22150),ht=o(11250),de=o(43702),fe=o(58856),Fe=o(40767),le=o(75904),Ue=o(55104),Ye=o(70256),a=o(33130),y=function(i){var e,n=(0,c.useState)({type:"form"}),r=S()(n,2),f=r[0],s=r[1],h=(0,c.useState)(""),F=S()(h,2),b=F[0],C=F[1],R=(0,c.useState)({}),V=S()(R,2),P=V[0],ee=V[1],Q=function(x){var k,E,v;(k=i.editNode)===null||k===void 0||k.setAttrByPath("text/text",x.name);var T=(E=i.editNode)===null||E===void 0?void 0:E.data.config;i.editNode&&(console.log("update graph data",x),i.editNode.setData(m()(m()({},i.editNode.data),{},{config:m()(m()({},T),x)}),{overwrite:!0})),console.log("submit---props.editNode.data.config"),console.log((v=i.editNode)===null||v===void 0?void 0:v.data.config),i==null||i.onSubmit()},l=function(x){if(x&&x.data){var k,E=x.data.config||{},v=x.attrs;return E.name=v==null||(k=v.text)===null||k===void 0?void 0:k.text,E}else return{name:""}};return(0,c.useEffect)(function(){if(i.editNode&&i.editNode.data){var g=i.editNode.data.config||{};C(i.editNode.data.configSchema||g.type)}},[i.editNode]),(0,c.useEffect)(function(){(0,Ye.CD)(b).then(function(g){console.log("nodeConfigSchemaChange"),console.log(g),s(g)})},[b]),(0,c.useEffect)(function(){var g,x,k=((g=i.editNode)===null||g===void 0?void 0:g.data.config)||{},E=m()({},k),v=(x=i.editNode)===null||x===void 0?void 0:x.attrs;v&&v.text&&v.text.text&&(E.name=v.text.text),ee(E)},[(e=i.editNode)===null||e===void 0?void 0:e.data]),(0,a.jsx)(Ue.Z,{config:f,values:m()({},P),onSubmit:Q})};function J(i){var e=[{key:"1",label:"\u8282\u70B9\u914D\u7F6E",children:(0,a.jsx)("div",{style:{padding:5},children:(0,a.jsx)(y,{editNode:i.editNode,onSubmit:i.onSubmit})})}];return(0,a.jsxs)("div",{style:{margin:0,height:"95vh",overflowY:"scroll"},children:[(0,a.jsx)(y,{editNode:i.editNode,onSubmit:i.onSubmit}),i!=null&&i.isCollapsed?"":(0,a.jsx)(le.ZP,{type:"text",style:{position:"absolute",top:10,right:15,fontSize:20,textAlign:"center"},onClick:function(){i==null||i.onClose()},children:"x"})]})}var N=J,ue=o(11904),A=o(54882),he={customNode:"customNode___sd76A",input:"input___Io7w3",switchNode:"switchNode___wB22H"},ie=function(e){return(0,a.jsx)("div",{className:he.customNode,children:(0,a.jsx)(A.Z,{className:"input",value:e==null?void 0:e.data,width:80})})},M=o(42761),$=function(e){return(0,a.jsx)("div",{className:styles.customNode,children:(0,a.jsx)(M.Z,{className:"input",value:e==null?void 0:e.data,width:80})})},G=function(e){var n,r,f,s=e.node,h=(n=s.data.config)===null||n===void 0?void 0:n.name,F=h||"case";return(0,a.jsxs)("div",{className:he.customNode,children:[(0,a.jsx)("span",{children:"case"}),(0,a.jsx)(A.Z,{addonAfter:h,className:"input",value:s==null||(r=s.data)===null||r===void 0||(f=r.config)===null||f===void 0?void 0:f.case,width:150,onChange:function(C){var R=s.data;s.setData(m()(m()({},R),{},{config:m()(m()({},R.config),{},{case:C.target.value})}))}})]})},W=function(e){var n,r=e.node;return(0,a.jsx)("div",{className:he.customNode,children:(0,a.jsx)(A.Z,{addonBefore:"switch",className:"input",value:(n=r.data)===null||n===void 0?void 0:n.config.condition,onChange:function(s){var h=r.data;r.setData(m()(m()({},h),{},{config:m()(m()({},h.config),{},{condition:s.target.value})}))},width:100})})},D={groups:{top:{position:"top",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},right:{position:"right",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}},zIndex:1},bottom:{position:"bottom",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}},left:{position:"left",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}}}},items:[{group:"top"},{group:"right"},{group:"bottom"},{group:"left"}]},Ge={groups:{right:{position:"right",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}},zIndex:1}},items:[{group:"right"}]},Xe={groups:{bottom:{position:"bottom",attrs:{circle:{r:4,magnet:!0,stroke:"#5F95FF",strokeWidth:1,fill:"#fff",style:{visibility:"hidden"}}},zIndex:1}},items:[{group:"bottom"}]},Qe=function(e){return(0,a.jsx)("div",{className:he.customNode,children:(0,a.jsx)("div",{style:{textAlign:"center",fontSize:"15px"},children:"default"})})};function qe(i){i.forEach(function(e){console.log("\u6CE8\u518C\u65B0\u8282\u70B9:"+e.name),ve.kJ.registerNode(e.name,e.config,!0)}),(0,ue.z2)({shape:"string",component:ie}),(0,ue.z2)({shape:"num",component:$}),(0,ue.z2)({shape:"switch",component:W}),(0,ue.z2)({shape:"switch-case",component:G}),(0,ue.z2)({shape:"switch-default",component:Qe})}function _e(i){var e=i.createNode({shape:"circle",label:"start",width:50,height:50,attrs:{body:{}},ports:Xe,data:{config:{type:"start"}}});i.addNode(e)}var et=(0,c.forwardRef)(function(i,e){return(0,a.jsx)("div",{className:"drag-graph",ref:e})}),tt=et,ot=function(e,n){var r,f,s,h,F=n.getData(),b=n.getPosition(),C=e.getNodes(),R;if(["ExtSharp","polygon"].indexOf(n.shape)>-1&&F!=null&&F.config&&F.config.type)switch(F.config.type){case"switch":var V=200,P=e.addNode({shape:"switch",position:b,width:V,height:50,ports:D,data:n.data,attrs:{body:{stroke:"#8f8f8f",strokeWidth:1,fill:"#fff",rx:6,ry:6}}});e.removeNode(n);var ee=e.addNode({shape:"switch-case",position:{y:b.y+100,x:b.x-V/2},width:120,height:50,ports:D,data:{config:{type:"switch-case"}}}),Q=e.addNode({shape:"switch-default",position:{y:b.y+100,x:b.x+V},width:120,height:50,ports:D,data:{config:{type:"switch-default"}}}),l=e.addEdge({source:P,sourcePort:(r=P.ports.items.find(function(O){return O.group=="bottom"}))===null||r===void 0?void 0:r.id,target:ee,targetPort:(f=ee.ports.items.find(function(O){return O.group=="top"}))===null||f===void 0?void 0:f.id,zIndex:0}),g=e.addEdge({source:P,sourcePort:(s=P.ports.items.find(function(O){return O.group=="bottom"}))===null||s===void 0?void 0:s.id,target:Q,targetPort:(h=Q.ports.items.find(function(O){return O.group=="top"}))===null||h===void 0?void 0:h.id,zIndex:0});R=P;break;case"switch-case":var x=e.createNode({shape:"switch-case",position:n.position(),width:120,height:50,ports:D,data:n.data});e.removeNode(n),e.addNode(x),R=x;break;case"string":var k=e.createNode({shape:"string",position:n.position(),width:100,height:50,ports:D,data:n.data});e.removeNode(n),e.addNode(k),R=k;break;case"num":var E=e.createNode({shape:"num",position:n.position(),width:100,height:50,ports:D,data:n.data});e.removeNode(n),e.addNode(E),R=E;break;case"assignment":var v=e.createNode({shape:"assignment",position:n.position(),width:220,height:50,ports:D,data:n.data});e.removeNode(n),e.addNode(v),R=v;break;default:break}if(["\u5DE5\u5E8F\u7EC4"].indexOf(n.getAttrByPath("text/text"))>-1&&(n.zIndex=-1),console.log("node:added"),R&&C.length==1){var T,ae,U,re,I;e.addEdge({source:C[0],sourcePort:(T=C[0].ports.items.find(function(O){return O.group=="bottom"}))===null||T===void 0?void 0:T.id,target:R,targetPort:(ae=R)===null||ae===void 0||(U=ae.ports)===null||U===void 0||(re=U.items)===null||re===void 0||(I=re.find(function(O){return O.group=="top"}))===null||I===void 0?void 0:I.id,zIndex:0})}},Je=o(72107),ke=o(71731),St=Le()(function i(){Ne()(this,i),De()(this,"logic",void 0)}),Wt=[{key:"saveToPng",label:"\u5BFC\u51FA\u56FE\u7247"}],Ct=Ie().createContext({logic:new Je.Iz("")}),Ht=null,Kt=null,gt=function(e,n){for(var r=0,f=e.length;r<f;r+=1)e[r].style.visibility=n?"visible":"hidden"},Nt=function(e){var n,r=(0,c.useState)(),f=S()(r,2),s=f[0],h=f[1],F=(0,c.useState)(!e.showLeft),b=S()(F,2),C=b[0],R=b[1],V=(0,c.useState)(!e.showRight),P=S()(V,2),ee=P[0],Q=P[1],l=(0,c.useState)(e.panelData),g=S()(l,2),x=g[0],k=g[1],E=(0,c.useState)(new St),v=S()(E,2),T=v[0],ae=v[1],U=(0,c.useState)(),re=S()(U,2),I=re[0],O=re[1],Te=(0,c.useState)(),xe=S()(Te,2),Y=xe[0],we=xe[1],me=(0,c.useState)(e.graphIns),pe=S()(me,2),L=pe[0],p=pe[1],z=(0,c.useState)("black"),q=S()(z,2),X=q[0],Se=q[1],ye=(0,c.useState)(),B=S()(ye,2),Ce=B[0],ut=B[1];(0,c.useEffect)(function(){try{qe(e.panelData.Shapes)}catch(u){console.error("\u6CE8\u518C\u8282\u70B9\u51FA\u9519\uFF1A"),console.error(u)}},[]),(0,c.useEffect)(function(){L&&(L.options.connecting.createEdge=e.createEdge)},[e.createEdge]),(0,c.useEffect)(function(){e.lineStyle&&e.lineStyle.color&&Se(e.lineStyle.color)},[e.lineStyle]),(0,c.useEffect)(function(){Y&&w(Y)},[Y]),(0,c.useEffect)(function(){if(L&&e.graphJson)try{L.fromJSON(e.graphJson)}catch(u){de.ZP.error("\u56FE\u6570\u636E\u6709\u8BEF\uFF0C\u5DF2\u5FFD\u7565"),console.log(e.graphJson)}},[e.graphJson]);function w(u){if(console.log("initGraph"),!!u){var t=e.graphIns;t||(t=new ve.kJ({container:u,embedding:{enabled:!0,findParent:function(j){var Z=j.node,K=Z.getBBox();return this.getNodes().filter(function(se){var Oe=se.getData();if(Oe&&Oe.parent){var Mt=se.getBBox();return K.isIntersectWithRect(Mt)}return!1})}},mousewheel:{enabled:!0,modifiers:"ctrl",minScale:.5,maxScale:3},connecting:{router:"manhattan",connector:{name:"rounded",args:{radius:15}},anchor:"center",connectionPoint:"anchor",allowBlank:!1,allowMulti:!0,snap:{radius:20},createEdge:e.createEdge,validateConnection:function(j){var Z=j.targetMagnet;return!!Z}},background:{color:"#F2F7FA"},grid:!0})),t.use(new ft.H({enabled:!0,sharp:!0})).use(new vt.A({enabled:!0})).use(new Be.Y({enabled:!0,multiple:!0,strict:!0,rubberband:!0,movable:!0,showNodeSelectionBox:!0,pointerEvents:"none"})).use(new Ve.T({enabled:!0})).use(new Ke.N).use(new _.T).use(new ht.D).use(new ke.w({resizing:{enabled:!0,minWidth:50,maxWidth:0,minHeight:50,maxHeight:0,orthogonal:!1,restrict:!1,preserveAspectRatio:!1}})),t.on("edge:dblclick",function(d){var j=d.cell}),t.on("edge:change:router",function(d){console.log("edge:change:router")}),t.on("edge:mouseenter",function(d){var j=d.cell;j.addTools([])}),t.on("edge:mouseleave",function(d){var j=d.cell}),t.on("node:mouseenter",function(d){var j,Z,K=d.cell;((j=K.data)===null||j===void 0||(Z=j.config)===null||Z===void 0?void 0:Z.type)!="start"&&K.addTools([{name:"button-remove",args:{x:"100%",y:0,offset:{x:-10,y:10}}}]);var se=Y==null?void 0:Y.querySelectorAll(".x6-port-body");gt(se,!0)}),t.on("node:mouseleave",function(d){var j=d.cell;j.removeTools();var Z=Y==null?void 0:Y.querySelectorAll(".x6-port-body");gt(Z,!1)}),t.on("node:click",function(d){var j=d.e,Z=d.x,K=d.y,se=d.node,Oe=d.view;se.removeTools(),h(se)}),t.on("node:added",function(d){var j=d.node,Z=d.index,K=d.options;ot(t,j)}),t.on("node:dblclick",function(d){var j=d.e,Z=d.x,K=d.y,se=d.node,Oe=d.view;Q(!1),h(se)}),t.bindKey(["meta+c","ctrl+c"],function(){var d=t.getSelectedCells();return d.length&&t.copy(d),!1}),t.bindKey(["meta+x","ctrl+x"],function(){var d=t.getSelectedCells();return d.length&&t.cut(d),!1}),t.bindKey(["meta+v","ctrl+v"],function(){if(!t.isClipboardEmpty()){var d=t.paste({offset:32});t.cleanSelection(),t.select(d)}return!1}),t.bindKey(["meta+z","ctrl+z"],function(){return t.canUndo()&&t.undo(),!1}),t.bindKey(["meta+shift+z","ctrl+shift+z"],function(){return t.canRedo()&&t.redo(),!1}),t.bindKey("backspace",function(){var d=t.getSelectedCells();d.length&&(d.find(function(j){var Z;return j.data?["start"].indexOf((Z=j.data.config)===null||Z===void 0?void 0:Z.type)>-1:!1})?de.ZP.error("\u7981\u6B62\u5220\u9664\u5F00\u59CB\u8282\u70B9\uFF01"):t.removeCells(d))}),t.on("blank:dblclick",function(d){var j=d.e,Z=d.x,K=d.y;console.log("blank:dbclick",Z,K)}),t.bindKey(["ctrl+1","meta+1"],function(){var d=t.zoom();d<1.5&&t.zoom(.1)}),t.bindKey(["ctrl+2","meta+2"],function(){var d=t.zoom();d>.5&&t.zoom(-.1)}),p(t);var H=x.Groups,te=new $e.t({title:"\u5C55\u5F00/\u6536\u8D77",target:t,search:function(j,Z){var K=j.getAttrByPath("text/text");return(K==null?void 0:K.indexOf(Z))!==-1},notFoundText:"\u672A\u627E\u5230",collapsable:!0,stencilGraphWidth:250,groups:H,layoutOptions:{rowHeight:100}});return I==null||I.appendChild(te.container),ut(te),e.config?(ae(m()(m()({},T),{},{logic:e.config})),t.fromJSON(T.logic.visualConfig)):_e(t),e.onGraphInsChange&&e.onGraphInsChange(t),t}}(0,c.useEffect)(function(){if(Ce&&e.panelData.Nodes){var u={};e.panelData.Nodes.forEach(function(t){var H=L.createNode(t.getNodeConfig());e.panelData.Groups.forEach(function(te){t.getGroups().includes(te.name)&&(u[te.name]?u[te.name].push(H):u[te.name]=[H])})}),Object.keys(u).forEach(function(t){Ce.load(oe()(u[t]),t)})}},[Ce,e.panelData.Nodes]);function ne(){e.onSave&&e.onSave(L)}return(0,a.jsx)(Ct.Provider,{value:T,children:(0,a.jsxs)(fe.Z,{style:{height:"100vh",width:"100%",margin:0},children:[(0,a.jsx)(fe.Z.Sider,{theme:"light",collapsed:C,collapsedWidth:0,width:250,ref:function(t){return O(t)}}),(0,a.jsxs)(fe.Z,{style:{height:"100%"},children:[(0,a.jsxs)(fe.Z.Header,{style:{padding:0,backgroundColor:"white"},children:[(0,a.jsxs)(Fe.Z,{direction:"horizontal",children:[(0,a.jsx)(le.ZP,{type:"text",icon:C?(0,a.jsx)(Pe.Z,{}):(0,a.jsx)(He.Z,{}),onClick:function(){R(!C)},style:{fontSize:"16px",width:64,height:64}}),(n=e.toolElements)===null||n===void 0?void 0:n.map(function(u){return u})]}),(0,a.jsx)(Fe.Z,{style:{float:"right",right:"16px"}})]}),(0,a.jsx)(fe.Z.Content,{className:"app-content",children:(0,a.jsx)(tt,{ref:function(t){return we(t)}})})]}),(0,a.jsx)(fe.Z.Sider,{theme:"light",collapsed:ee,collapsedWidth:0,width:600,children:(0,a.jsx)(N,{editNode:s,onSubmit:ne,onClose:function(){Q(!0)},isCollapsed:ee})})]})})},bt=Nt,$t=o(10486),Vt=o(14232),Ut=o(37555),Yt=o(59998),Xt=o(88287),Qt=o(23620),qt=Ie().createContext({logic:new Je.Iz("")}),_t=function(e){var n,r=useState(),f=_slicedToArray(r,2),s=f[0],h=f[1],F=useState(),b=_slicedToArray(F,2),C=b[0],R=b[1],V=useState(!1),P=_slicedToArray(V,2),ee=P[0],Q=P[1],l=useState(!0),g=_slicedToArray(l,2),x=g[0],k=g[1],E=useState(),v=_slicedToArray(E,2),T=v[0],ae=v[1],U=useState(),re=_slicedToArray(U,2),I=re[0],O=re[1],Te=useState(),xe=_slicedToArray(Te,2),Y=xe[0],we=xe[1],me=useState(),pe=_slicedToArray(me,2),L=pe[0],p=pe[1],z=useState(),q=_slicedToArray(z,2),X=q[0],Se=q[1],ye=useRef(),B=function(ne){var u=ne.node;p(u);var t=I==null?void 0:I.itemLogs.find(function(H){return H.config.id==u.id});ae(t)};useEffect(function(){Y&&(s==null||s.centerCell(Y))},[Y,s]),useEffect(function(){console.log("play curItemLog",T)},[T]),useEffect(function(){var w=s==null?void 0:s.getNodes().find(function(ne){return ne.id==e.nextId});w==null||w.attr("body/fill","red"),we(w)},[e.nextId]),useEffect(function(){var w;s==null||(w=s.getNodes().find(function(ne){return ne.id==e.nextId}))===null||w===void 0||w.attr("body/fill","red")},[s]),useEffect(function(){e.config&&R(e.config)},[e.config]),useEffect(function(){var w,ne;console.log("props.debugLogs",e.debugLogs),((w=e.debugLogs)===null||w===void 0?void 0:w.length)>0&&setInterval(Ce,2e3);var u=[];e&&((ne=e.debugLogs)===null||ne===void 0||ne.forEach(function(t){var H,te;u.push({children:_jsx(_Fragment,{children:_jsxs("span",{style:{cursor:"pointer",fontWeight:t.id==(I==null?void 0:I.id)?"bolder":"normal",color:t.id==(I==null?void 0:I.id)?"#52c41a":"black"},onClick:function(){O(t),console.log(t),s==null||s.fromJSON(C==null?void 0:C.visualConfig);var j;t.itemLogs.forEach(function(Z){var K=s==null?void 0:s.getNodes().find(function(se){return se.id==Z.config.id});K&&(K.attr("body/fill","#52c41a"),j=K)}),s==null||s.centerCell(j),ae({}),p({})},children:[_jsx("p",{children:(H=t.itemLogs[0])===null||H===void 0?void 0:H.config.name}),((te=e.logicIns)===null||te===void 0?void 0:te.version)==t.version?_jsx("p",{}):_jsx("p",{children:_jsxs(Space,{children:[_jsx(Typography.Paragraph,{style:{color:"red"},children:"\u7248\u672C\u53F7:"}),_jsxs(Typography.Paragraph,{copyable:{tooltips:["\u70B9\u51FB\u590D\u5236","\u590D\u5236\u6210\u529F!"],text:t.version},children:[t.version,_jsx(Typography.Link,{style:{margin:"5px"},href:"#/assets/logic/i/".concat(t.logicId,"/view/").concat(t.version),target:"_blank",children:_jsx(ApartmentOutlined,{})})]})]})}),_jsxs("p",{children:["\u4E1A\u52A1\u6807\u8BC6\uFF1A",t.bizId]}),_jsx("p",{children:t.serverTime}),_jsx("p",{children:t.message})]})}),color:t.success?"green":"red"})})),Se(u)},[e.debugLogs,e.logicIns,s,I]),useEffect(function(){if(C){try{var w=InitPanelData(),ne=w.Shapes;RegistShape(ne)}catch(t){console.error("\u6CE8\u518C\u8282\u70B9\u51FA\u9519\uFF1A"),console.error(t)}var u=new Graph({container:ye.current,embedding:{enabled:!0,validate:function(H){return H.child.setData({hoverNode:H.parent}),!0}},mousewheel:{enabled:!0,modifiers:"ctrl",minScale:.5,maxScale:3},connecting:{router:"manhattan",connector:{name:"rounded",args:{radius:15}},anchor:"center",connectionPoint:"anchor",allowBlank:!1,allowMulti:!0,snap:{radius:20},createEdge:function(){return new Shape.Edge({tools:[{name:"edge-editor",args:{attrs:{backgroundColor:"#fff"}}}],zIndex:0})},validateConnection:function(H){var te=H.targetMagnet;return!!te}},highlighting:{magnetAdsorbed:{name:"stroke",args:{attrs:{fill:"#5F95FF",stroke:"#5F95FF"}}}},background:{color:"#F2F7FA"},grid:!0});u.use(new Snapline({enabled:!0,sharp:!0})).use(new History({enabled:!0})).use(new Selection({enabled:!0,multiple:!0,strict:!0,rubberband:!0,movable:!0,showNodeSelectionBox:!0,pointerEvents:"none"})).use(new Scroller({enabled:!0})).use(new Keyboard),u.on("edge:dblclick",function(){}),u.on("edge:mouseenter",function(){}),u.on("edge:mouseleave",function(){}),u.on("node:moved",function(){}),u.on("node:mouseenter",function(){}),u.on("node:mouseleave",function(){}),u.on("node:added",function(){}),u.on("node:dblclick",function(t){var H=t.node;k(!1)}),u.on("blank:dblclick",function(t){var H=t.x,te=t.y}),u.fromJSON(C.visualConfig),autoDagreLayout(u),h(u)}},[C]),useEffect(function(){s==null||s.off("node:click",B),s==null||s.on("node:click",B)},[I]);var Ce=function(){},ut=[{key:"1",label:"\u65E5\u5FD7",children:_jsx(JsonView,{src:T})},{key:"2",label:"\u8282\u70B9\u914D\u7F6E",children:_jsx(NodeData,{editNode:L,configSchemaProvider:e.configSchemaProvider})}];return _jsxs(Layout,{style:{margin:0,height:"100vh"},children:[_jsxs(Layout.Sider,{theme:"light",collapsedWidth:0,width:300,style:{overflow:"auto",height:"100vh",position:"fixed",left:0,top:0,bottom:0,borderRight:"0.5px solid"},children:[_jsx(Divider,{children:"\u6700\u8FD1\u8BF7\u6C42"}),_jsx(Timeline,{style:{height:"100%"},items:X})]}),_jsxs(Layout,{style:{marginLeft:300},children:[_jsxs(Layout.Header,{style:{backgroundColor:"white",padding:0},children:[_jsxs(Space,{direction:"horizontal",style:{},children:[_jsx(Divider,{type:"vertical"}),(n=e.btns)===null||n===void 0?void 0:n.map(function(w){return w})]}),_jsx(Button,{type:"text",icon:x?_jsx(MenuFoldOutlined,{}):_jsx(MenuUnfoldOutlined,{}),onClick:function(){k(!x)},style:{float:"right",right:"16px",fontSize:"16px",width:64,height:64}})]}),_jsx(Layout.Content,{className:"app-content",children:_jsx(DagreGraph,{ref:ye})})]}),_jsxs(Layout.Sider,{theme:"light",collapsed:x,collapsedWidth:0,style:{overflow:"scroll"},title:"ddd",width:500,children:[_jsx(Button,{type:"text",onClick:function(){k(!x)},style:{float:"right",fontSize:"16px",width:64,height:64},children:"x"}),_jsx(Tabs,{items:ut,defaultActiveKey:"1"})]})]})},eo=null,Ae=o(95812),nt=o(22983),Pt=o(52615),it=o(7995),jt=o(98306),at=o(70517),Et=o(99273),to=50,Lt=50,Dt=[{name:"ExtSharp",config:{width:100,height:Lt,attrs:{body:{rx:6,ry:6,stroke:"#5F95FF",strokeWidth:1,fill:"rgba(95,149,255,0.05)",refWidth:1,refHeight:1},image:{refX:2,refY:0},text:{refX:4,refY:20,fontSize:12,"text-anchor":"start"}},markup:[{tagName:"rect",selector:"body"},{tagName:"image",selector:"image"},{tagName:"text",selector:"label"}]}}],Ft=function(){function i(e){Ne()(this,i),De()(this,"_nodeConfig",void 0),De()(this,"_groups",void 0),this._nodeConfig=JSON.parse(JSON.stringify(e))}return Le()(i,[{key:"getNodeConfig",value:function(){return this._nodeConfig}},{key:"getGroups",value:function(){return this._groups}},{key:"setLabel",value:function(n){this._nodeConfig.attrs&&(this._nodeConfig.attrs.text.text=n)}},{key:"setGroups",value:function(n){this._groups=n}},{key:"setConfigSchemel",value:function(n){this._nodeConfig.data?(this._nodeConfig.data.configSchema=n,this._nodeConfig.data.config={type:n}):this._nodeConfig.data={configSchema:n,config:{type:n}}}},{key:"setConfigData",value:function(n){this._nodeConfig.data?this._nodeConfig.data.config=n:this._nodeConfig.data={config:n}}}]),i}(),rt=80,kt=80,je={body:{fill:"#fff",stroke:"#8f8f8f",strokeWidth:1}},ce=new Map;ce.set("group",{x:40,y:40,width:100,height:50,ports:D,attrs:{body:m()(m()({},je.body),{},{stroke:"black",strokeWidth:1,fillOpacity:0}),text:{text:"\u5DE5\u5E8F\u7EC4",refX:0,refY:10,"text-anchor":"start"}},data:{parent:!0}}),ce.set("end",{shape:"circle",width:60,height:60,attrs:{body:m()(m()({},je.body),{},{fill:"gray"}),text:{text:"end"}},markup:[{tagName:"circle",selector:"body"},{tagName:"text",selector:"label"}],ports:D,data:{configScheme:"end"}}),ce.set("circle",{shape:"circle",width:60,height:60,attrs:{body:m()(m()({},je.body),{},{fill:"white"}),text:{text:""}},markup:[{tagName:"circle",selector:"body"},{tagName:"text",selector:"label"}],ports:D,data:{},groups:["process"]}),ce.set("triangle",{shape:"path",x:40,y:40,width:rt,height:60,path:"M3,45 C1.9,45 1,44.2 1,43.1 L29,2.9 C30.1,1.3 31.3,1 32.1,1 L32.1,1 C32.1,1 33.8,1.1 35.1,2.9 L63,43.1 C63,44.1 62.1,45 61,45 L3,45 L3,45 Z",attrs:{body:m()(m()({},je.body),{},{fill:"white"}),text:{text:"\u4E09\u89D2\u5F62",refY:50}},ports:D,data:{config:{}}}),ce.set("triangle2",{shape:"path",x:40,y:40,width:rt,height:60,path:"M3,1 C1.9,1 1,1.8 1,2.9 L29,43.1 C30.1,44.7 31.3,45 32.1,45 L32.1,45 C32.1,45 33.8,44.9 35.1,43.1 L63,2.9 C63,1.9 62.1,1 61,1 L3,1 L3,1 Z",attrs:{body:m()(m()({},je.body),{},{fill:"white"}),text:{text:"\u914D\u6599\u5DE5\u5E8F",refY:10}},ports:D,data:{config:{type:"process"}},groups:["process"]}),ce.set("rhombus",{shape:"polygon",x:600,y:70,width:rt,height:kt,points:"0,10 10,0 20,10 10,20",attrs:{body:m()({},je.body),text:{text:"\u68C0\u9A8C\u5DE5\u5E8F"}},ports:D,data:{config:{type:"process"}},groups:["process"]}),ce.set("ExtSharp",{shape:"ExtSharp",attrs:{text:{text:"http\u8BF7\u6C42",fontSize:14},image:{width:20,x:2,y:2}},ports:D});function ge(i){return new Ft(ce.get(i))}var At=ce;function Tt(i,e,n){var r=80,f=80,s={body:{fill:"#fff",stroke:"#8f8f8f",strokeWidth:1}},h=At.get("end"),F=[h];i&&i.length>0&&Array.prototype.push.apply(F,i);var b=[{name:"process",title:"\u5DE5\u5E8F",graphHeight:600}];e&&e.length>0&&Array.prototype.push.apply(b,e);var C=Dt;return n&&n.length>0&&Array.prototype.push.apply(C,n),{Shapes:C,Nodes:F,Groups:b}}var wt=o(72237),mt=o(52943),Zt=o(25359),Ee=o.n(Zt),Rt=o(49811),st=o.n(Rt);function It(){return dt.apply(this,arguments)}function dt(){return dt=st()(Ee()().mark(function i(){return Ee()().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",(0,at.Z)("/api/mes/asm-system/bbs/v1/common/dictionaries/list",{method:"post",data:{applicationCode:"bbs",dictionaryCategoryCode:"GROUP-TYPES",isEnabled:!0}}).then(function(r){if(r.data){var f=r.data;return f}else return[]}));case 1:case"end":return n.stop()}},i)})),dt.apply(this,arguments)}var Bt=function(){function i(){Ne()(this,i)}return Le()(i,[{key:"graphToMesDsl",value:function(n,r){var f=[],s=[],h=n==null?void 0:n.getCells(),F={},b=r||{};return b.routeProductDetailList=[],h.forEach(function(C){var R=C.id||"";if(C.shape==="edge"){var V,P=C,ee=((V=P.labels)===null||V===void 0?void 0:V.length)>0?P.labels[0].attrs.label.text:"",Q=P.data.type,l=P.getSourceNode(),g=P.getTargetNode();debugger;if(g.getChildCount()>0){var x=g.getChildren();x==null||x.forEach(function(v){var T;(T=b.routeProductDetailList)===null||T===void 0||T.push({fromNode:l==null?void 0:l.id,fromNodeName:l==null?void 0:l.getAttrByPath("text/text"),toNode:v.id,toNodeName:v.getAttrByPath("text/text"),productCode:r==null?void 0:r.productCode,productName:r==null?void 0:r.productName,routeType:Q,routeDetailDto:v.data.config,inputOutputRatio:ee})})}else if((l==null?void 0:l.getChildCount())>0){var k=l==null?void 0:l.getChildren();k==null||k.forEach(function(v){var T;(T=b.routeProductDetailList)===null||T===void 0||T.push({fromNode:v.id,fromNodeName:v.getAttrByPath("text/text"),toNode:g.id,toNodeName:g==null?void 0:g.getAttrByPath("text/text"),productCode:r==null?void 0:r.productCode,productName:r==null?void 0:r.productName,routeType:Q,routeDetailDto:v.data.config,inputOutputRatio:ee})})}else{var E;(E=b.routeProductDetailList)===null||E===void 0||E.push({fromNode:l==null?void 0:l.id,fromNodeName:l==null?void 0:l.getAttrByPath("text/text"),toNode:g.id,toNodeName:g==null?void 0:g.getAttrByPath("text/text"),routeType:Q,productCode:r==null?void 0:r.productCode,productName:r==null?void 0:r.productName,routeDetailDto:l==null?void 0:l.data.config,inputOutputRatio:ee})}}}),b}}]),i}(),yt=new at.Z.Axios({headers:{Authorization:"Bearer "+localStorage.getItem("token"),"Content-Type":"application/json"}}),Gt=function(){function i(){Ne()(this,i)}return Le()(i,[{key:"updateRouteProcessDesign",value:function(){var e=st()(Ee()().mark(function r(f){return Ee()().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return h.abrupt("return",yt.post("/api/mes/asm-standard/route/update-route-process-design",JSON.stringify(f)));case 1:case"end":return h.stop()}},r)}));function n(r){return e.apply(this,arguments)}return n}()},{key:"getRouteProcessDesign",value:function(){var e=st()(Ee()().mark(function r(f,s){return Ee()().wrap(function(F){for(;;)switch(F.prev=F.next){case 0:return F.abrupt("return",yt.post("/api/mes/asm-standard/route/route-process-design",JSON.stringify({version:s,productCode:f})));case 1:case"end":return F.stop()}},r)}));function n(r,f){return e.apply(this,arguments)}return n}()}]),i}(),lt=Tt(),oo=lt.Nodes,Jt=lt.Shapes,no=lt.Groups,xt=new Gt,Ot=function(){var e=(0,c.useState)({}),n=S()(e,2),r=n[0],f=n[1],s=(0,c.useState)({}),h=S()(s,2),F=h[0],b=h[1],C=(0,c.useState)(!1),R=S()(C,2),V=R[0],P=R[1],ee=(0,jt.lr)(),Q=S()(ee,2),l=Q[0],g=Q[1],x=(0,c.useState)("1"),k=S()(x,2),E=k[0],v=k[1],T=(0,c.useState)(),ae=S()(T,2),U=ae[0],re=ae[1],I=(0,c.useState)([]),O=S()(I,2),Te=O[0],xe=O[1];function Y(L){r.graphData=JSON.stringify(L.toJSON());var p=new Bt().graphToMesDsl(L,r);f(p),P(!0),xt.updateRouteProcessDesign(p).then(function(z){console.log("\u4FDD\u5B58\u63A5\u53E3\u8FD4\u56DE");var q=JSON.parse(z.data);q.code=="500"?de.ZP.error(q.message):de.ZP.success("\u4FDD\u5B58\u6210\u529F"),P(!1)}).catch(function(z){de.ZP.error(z),P(!1)})}(0,c.useEffect)(function(){P(!0),xt.getRouteProcessDesign(l.get("prodCode"),l.get("version")).then(function(q){var X=JSON.parse(q.data);X.result&&(f(X.result),b(X.result.graphData?JSON.parse(X.result.graphData):{})),P(!1)}).catch(function(q){P(!1),console.log("err"),console.log(q)});var L=[],p=ge("circle");debugger;p==null||p.setConfigSchemel("start"),p==null||p.setConfigData({name:"start"}),p==null||p.setLabel("start"),p.setGroups(["def"]),L.push(p);var z=ge("circle");z==null||z.setConfigSchemel("end"),z==null||z.setLabel("end"),z==null||z.setGroups(["def"]),L.push(z),It().then(function(q){console.log("\u62C9\u53D6\u5927\u7C7B\u6570\u636E"),console.log(q),q.data.forEach(function(Se){var ye,B;switch(Se.key){case"PROCESS_GROUP":B=ge("circle"),B.setConfigSchemel("process");break;case"CHECK_GROUP":B=ge("rhombus"),B.setConfigSchemel("process");break;case"WAIT_GROUP":B=ge("triangle"),B.setConfigSchemel("process");break;case"PICK_GROUP":B=ge("triangle2"),B.setConfigSchemel("process");break;default:B=ge("ExtSharp"),B.setConfigSchemel("process");break}(ye=B)===null||ye===void 0||ye.setConfigData(Se),B.setLabel(Se.text),B.setGroups(["process"]);var Ce=B;L.push(Ce)});var X=ge("group");X==null||X.setLabel("\u5DE5\u5E8F\u7EC4"),X==null||X.setConfigSchemel("process-group"),X.setGroups(["process"]),L.push(X),console.log("cusNodes"),console.log(L),xe(L)})},[]);var we=(0,c.useCallback)(function(){return new ve.bn.kS({attrs:{line:{targetMarker:"classic",stroke:E=="1"?"black":"red"}},tools:[{name:"edge-editor",args:{attrs:{backgroundColor:"#fff"}}}],zIndex:0,data:{type:E}})},[E]),me=Ae.Z.Text,pe=function(){return(0,a.jsxs)(Fe.Z,{style:{height:"50px"},children:[(0,a.jsx)(Ae.Z,{children:"\u4EA7\u54C1\u7F16\u7801"}),(0,a.jsx)(me,{underline:!0,children:l==null?void 0:l.get("prodCode")}),(0,a.jsx)(nt.Z,{type:"vertical"}),(0,a.jsx)(Ae.Z,{children:"\u4EA7\u54C1\u540D\u79F0"}),(0,a.jsx)(me,{underline:!0,children:l==null?void 0:l.get("prodName")}),(0,a.jsx)(nt.Z,{type:"vertical"}),(0,a.jsx)(Ae.Z,{children:"\u5BA2\u6237\u6599\u53F7"}),(0,a.jsx)(me,{underline:!0,children:l.get("cusCode")}),(0,a.jsx)(nt.Z,{type:"vertical"}),(0,a.jsx)(Ae.Z,{children:"\u7248\u672C\u53F7"}),(0,a.jsx)(me,{underline:!0,children:l.get("version")})]})};return(0,a.jsxs)("div",{children:[(0,a.jsx)(pe,{}),(0,a.jsx)(Pt.Z,{spinning:V,children:(0,a.jsx)(bt,{panelData:{Nodes:oe()(Te),Shapes:Jt,Groups:[{name:"def",title:"\u9ED8\u8BA4\u8282\u70B9",graphHeight:100},{name:"process",title:"\u5DE5\u5E8F",graphHeight:400}]},showLeft:!0,graphIns:U,toolElements:[(0,a.jsx)(le.ZP,{icon:(0,a.jsx)(wt.Z,{}),type:"primary",onClick:function(){Y(U)},children:"\u4FDD\u5B58"}),(0,a.jsxs)("span",{children:["\u8FDE\u63A5\u7EBF\u7C7B\u578B\uFF1A",(0,a.jsxs)(it.Z,{style:{width:"100px"},value:E,onSelect:function(p){v(p)},children:[(0,a.jsx)(it.Z.Option,{children:"\u52A0\u5DE5\u7EBF"},"1"),(0,a.jsx)(it.Z.Option,{children:"\u8FD4\u5DE5\u7EBF"},"2")]})]}),(0,a.jsx)(le.ZP,{icon:(0,a.jsx)(mt.g9,{}),onClick:function(){debugger;U&&U.canUndo()&&U.undo()},children:"\u64A4\u9500"}),(0,a.jsx)(le.ZP,{icon:(0,a.jsx)(mt.NW,{}),onClick:function(){debugger;U&&U.canRedo()&&U.undo()},children:"\u91CD\u505A"}),(0,a.jsx)(le.ZP,{onClick:function(){at.Z.post("/api/mes/asm-system/bbs/v1/common/accounts/employee/access-token",{loginName:"admin",password:"1234@qwer"}).then(function(p){debugger;Et.F.setTokenToLocal(p.data.data.accessToken),de.ZP.success(p.data.data.accessToken)}).catch(function(p){return de.ZP.error(p.toString())})},children:"\u83B7\u53D6\u6743\u9650"})],graphJson:F,createEdge:we,onSave:Y,onGraphInsChange:function(p){return re(p)}})})]})},zt=Ot}}]);
