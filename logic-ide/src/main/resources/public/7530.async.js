"use strict";(self.webpackChunkxuanwu_logic_web_design=self.webpackChunkxuanwu_logic_web_design||[]).push([[7530],{47530:function(B,S,v){v.r(S),v.d(S,{ServiceRenderer:function(){return x},default:function(){return C},eventTypes:function(){return b}});var s=v(15767),T=v(87363),F=v.n(T),w=v(51760),E=v.n(w),R=v(32222),I=v.n(R),c=v(42977),A=v(94391),U=v(69143),O=v.n(U),W=v(6663),b=["inited","onApiFetched","onSchemaApiFetched","onWsFetched"],C=function(y){(0,s.ZT)(o,y);function o(t){var e=y.call(this,t)||this;return e.dataProviders=e.initDataProviders(t.dataProvider),e.handleQuery=e.handleQuery.bind(e),e.handleAction=e.handleAction.bind(e),e.handleChange=e.handleChange.bind(e),e.reload=e.reload.bind(e),e.silentReload=e.silentReload.bind(e),e.initInterval=e.initInterval.bind(e),e.afterDataFetch=e.afterDataFetch.bind(e),e.afterSchemaFetch=e.afterSchemaFetch.bind(e),e.runDataProvider=e.runDataProvider.bind(e),e.dataProviderSetData=e.dataProviderSetData.bind(e),e}return o.prototype.componentDidMount=function(){return(0,s.mG)(this,void 0,void 0,function(){var t,e,r,i;return(0,s.Jh)(this,function(a){switch(a.label){case 0:return t=this.props,e=t.data,r=t.dispatchEvent,this.mounted=!0,[4,r("init",e,this)];case 1:return i=a.sent(),i!=null&&i.prevented?[2]:(this.initFetch(),[2])}})})},o.prototype.componentDidUpdate=function(t){var e=this,r,i=this.props,a=i.store,n=i.messages,d=n.fetchSuccess,u=n.fetchFailed;i.dataProvider!==t.dataProvider&&(this.dataProviders=this.initDataProviders(i.dataProvider),this.dataProviders&&(!((r=this.dataProviders)===null||r===void 0)&&r.inited)&&this.runDataProvider("inited")),(0,c.rMT)(t.api,i.api,t.data,i.data)&&(0,c.X1t)(i.api,a.data)&&a.fetchData(i.api,a.data,{successMessage:d,errorMessage:u}).then(function(h){e.runDataProvider("onApiFetched"),e.afterDataFetch(h)}),(0,c.rMT)(t.schemaApi,i.schemaApi,t.data,i.data)&&(0,c.X1t)(i.schemaApi,a.data)&&a.fetchSchema(i.schemaApi,a.data,{successMessage:d,errorMessage:u}).then(function(h){e.runDataProvider("onSchemaApiFetched"),e.afterSchemaFetch(h)}),i.ws&&t.ws!==i.ws&&(this.socket&&this.socket.close(),this.socket=this.fetchWSData(i.ws,a.data)),(0,c.RjM)(t.defaultData,i.defaultData)&&a.reInitData(i.defaultData)},o.prototype.componentWillUnmount=function(){this.mounted=!1,this.runDataProviderUnsubscribe(),clearTimeout(this.timer),this.socket&&this.socket.close&&this.socket.close()},o.prototype.doAction=function(t,e,r,i){if(r===void 0&&(r=!1),(t==null?void 0:t.actionType)==="rebuild"){var a=this.props,n=a.schemaApi,d=a.store,u=a.dataProvider,h=a.messages,l=h.fetchSuccess,p=h.fetchFailed;d.updateData(i),clearTimeout(this.timer),(0,c.X1t)(n,d.data)&&d.fetchSchema(n,d.data,{successMessage:l,errorMessage:p}).then(this.afterSchemaFetch),u&&this.runDataProvider("inited")}},o.prototype.initFetch=function(){var t=this,e=this.props,r=e.schemaApi,i=e.initFetchSchema,a=e.api,n=e.ws,d=e.initFetch,u=e.initFetchOn,h=e.dataProvider,l=e.store,p=e.messages,f=p.fetchSuccess,g=p.fetchFailed;(0,c.X1t)(r,l.data,i)&&l.fetchSchema(r,l.data,{successMessage:f,errorMessage:g}).then(function(m){t.runDataProvider("onSchemaApiFetched"),t.afterSchemaFetch(m)}),(0,c.X1t)(a,l.data,d,u)&&l.fetchInitData(a,l.data,{successMessage:f,errorMessage:g}).then(function(m){t.runDataProvider("onApiFetched"),t.afterDataFetch(m)}),n&&(this.socket=this.fetchWSData(n,l.data)),h&&this.runDataProvider("inited")},o.prototype.initDataProviders=function(t){var e=this,r=O()(t)?I()(t):t,i={};if(r)if(O()(r))Object.keys(r).forEach(function(n){var d=e.normalizeProvider(r[n],n);i=E()(i,d||{})});else{var a=this.normalizeProvider(r,"inited");i=E()(i,a||{})}return i},o.prototype.normalizeProvider=function(t,e){var r,i;if(e===void 0&&(e="inited"),!~b.indexOf(e))return null;if(typeof t=="function")return r={},r[e]=t,r;if(typeof t=="string"){var a=(0,c.S0D)(t,"data","setData","env");return a?(i={},i[e]=a,i):null}return null},o.prototype.runDataProvider=function(t){return(0,s.mG)(this,void 0,void 0,function(){var e,r,i,a;return(0,s.Jh)(this,function(n){switch(n.label){case 0:return this.runDataProviderUnsubscribe(t),e=this.props.store,r=this.dataProviders,r&&~b.indexOf(t)?(i=r[t],i&&typeof i=="function"?[4,i(e.data,this.dataProviderSetData,this.props.env)]:[3,2]):[3,2];case 1:a=n.sent(),typeof a=="function"&&(this.dataProviderUnsubscribe||(this.dataProviderUnsubscribe={}),this.dataProviderUnsubscribe[t]=a),n.label=2;case 2:return[2]}})})},o.prototype.runDataProviderUnsubscribe=function(t){var e,r=this.dataProviderUnsubscribe;if(r)if(t){var i=r[t];try{i&&typeof i=="function"&&i()}catch(a){console.error(a)}}else(e=Object.keys(r))===null||e===void 0||e.forEach(function(a){var n=r[a];try{n&&typeof n=="function"&&n()}catch(d){console.error(d)}})},o.prototype.dataProviderSetData=function(t){if(this.mounted){var e=this.props.store;e.updateData(t,void 0,!1),e.setHasRemoteData()}},o.prototype.fetchWSData=function(t,e){var r=this,i=this.props,a=i.env,n=i.store,d=(0,c.xkX)(t,e);a.wsFetcher(d,function(u){var h,l,p,f,g=u;if("status"in u&&"data"in u&&(g=u.data,u.status!==0)){n.updateMessage((l=(h=d==null?void 0:d.messages)===null||h===void 0?void 0:h.failed)!==null&&l!==void 0?l:u.msg,!0),a.notify("error",(f=(p=d==null?void 0:d.messages)===null||p===void 0?void 0:p.failed)!==null&&f!==void 0?f:u.msg);return}n.updateData(g,void 0,!1,d.concatDataFields),n.setHasRemoteData(),r.runDataProvider("onWsFetched"),r.afterDataFetch({ok:!0,data:g})},function(u){n.updateMessage(u,!0),a.notify("error",u)})},o.prototype.afterDataFetch=function(t){var e,r=t!=null&&t.hasOwnProperty("ok")?(e=t.data)!==null&&e!==void 0?e:{}:t,i=this.props,a=i.onBulkChange,n=i.dispatchEvent,d=i.store,u=i.formStore;(0,W.fh)(d)&&(n==null||n("fetchInited",(0,c.nW9)(this.props.data,(0,s.pi)((0,s.pi)({},r),{__response:{msg:d.msg,error:d.error},responseData:r,responseStatus:(t==null?void 0:t.status)===void 0?d.error?1:0:t==null?void 0:t.status,responseMsg:d.msg}))),!(0,c.xbD)(r)&&a&&u&&a(r,!1,{type:"api"}),t!=null&&t.ok&&this.initInterval(r))},o.prototype.afterSchemaFetch=function(t){var e=this.props,r=e.onBulkChange,i=e.formStore,a=e.dispatchEvent,n=e.store;a==null||a("fetchSchemaInited",(0,s.pi)((0,s.pi)({},t),{__response:{msg:n.msg,error:n.error},responseData:t,responseStatus:(t==null?void 0:t.status)===void 0?n.error?1:0:t==null?void 0:t.status,responseMsg:n.msg})),i&&(t!=null&&t.data)&&r&&r&&r(t.data),this.initInterval(t)},o.prototype.initInterval=function(t){var e=this.props,r=e.interval,i=e.silentPolling,a=e.stopAutoRefreshWhen,n=e.data;return clearTimeout(this.timer),r&&this.mounted&&(!a||!(0,c.fz_)(a,(0,c.nW9)(n,t)))&&(this.timer=setTimeout(i?this.silentReload:this.reload,Math.max(r,1e3))),t},o.prototype.reload=function(t,e,r,i,a){return(0,s.mG)(this,void 0,void 0,function(){var n,d,u,h,l,p,f,g,m,P,M,_,_;return(0,s.Jh)(this,function(D){switch(D.label){case 0:return e?[2,this.receive(e,void 0,a)]:(n=this.props,d=n.schemaApi,u=n.initFetchSchema,h=n.api,l=n.initFetch,p=n.initFetchOn,f=n.store,g=n.dataProvider,m=n.messages,P=m.fetchSuccess,M=m.fetchFailed,clearTimeout(this.timer),(0,c.X1t)(d,f.data)?[4,f.fetchSchema(d,f.data,{successMessage:P,errorMessage:M})]:[3,3]);case 1:return _=D.sent(),[4,this.runDataProvider("onApiFetched")];case 2:D.sent(),this.afterSchemaFetch(_),D.label=3;case 3:return(0,c.X1t)(h,f.data)?[4,f.fetchData(h,f.data,{silent:i,successMessage:P,errorMessage:M})]:[3,6];case 4:return _=D.sent(),[4,this.runDataProvider("onSchemaApiFetched")];case 5:D.sent(),this.afterDataFetch(_),D.label=6;case 6:return g?[4,this.runDataProvider("inited")]:[3,8];case 7:D.sent(),D.label=8;case 8:return[2,f.data]}})})},o.prototype.silentReload=function(t,e){this.reload(t,e,void 0,!0)},o.prototype.receive=function(t,e,r){return(0,s.mG)(this,void 0,void 0,function(){var i;return(0,s.Jh)(this,function(a){return i=this.props.store,i.updateData(t,void 0,r),[2,this.reload()]})})},o.prototype.handleQuery=function(t){var e=this;if(this.props.api||this.props.schemaApi){if(t!=null&&t.hasOwnProperty("orderBy")&&[this.props.api,this.props.schemaApi].every(function(r){return!r||!(0,c.rMT)(r,r,e.props.store.data,(0,c.nW9)(e.props.store.data,t))}))return!1;this.receive(t);return}return this.props.onQuery?this.props.onQuery(t):!1},o.prototype.reloadTarget=function(t,e){},o.prototype.handleDialogConfirm=function(t,e,r,i){var a=this.props.store;a.closeDialog(!0,t)},o.prototype.handleDialogClose=function(t){t===void 0&&(t=!1);var e=this.props.store;e.closeDialog(t)},o.prototype.openFeedback=function(t,e){var r=this;return new Promise(function(i){var a=r.props.store;a.setCurrentAction({type:"button",actionType:"dialog",dialog:t},r.props.resolveDefinitions),a.openDialog(e,void 0,function(n){i(n)},r.context)})},o.prototype.handleAction=function(t,e,r,i,a){var n=this;i===void 0&&(i=!1);var d=this.props,u=d.onAction,h=d.store,l=d.env,p=d.api,f=d.translate;return p&&e.actionType==="ajax"?(h.setCurrentAction(e,this.props.resolveDefinitions),h.saveRemote(e.api,r,{successMessage:f(e.messages&&e.messages.success),errorMessage:f(e.messages&&e.messages.failed)}).then(function(g){return(0,s.mG)(n,void 0,void 0,function(){var m;return(0,s.Jh)(this,function(P){switch(P.label){case 0:return this.afterDataFetch(g),e.feedback&&(0,c.pn4)(e.feedback,h.data)?[4,this.openFeedback(e.feedback,h.data)]:[3,2];case 1:P.sent(),P.label=2;case 2:return m=e.redirect&&(0,c.hXT)(e.redirect,h.data),m&&l.jumpTo(m,e,h.data),e.reload&&this.reloadTarget((0,c.u22)(e.reload,h.data),h.data),[2]}})})}).catch(function(g){if(i||e.countDown)throw g})):u(t,e,r,i,a||this.context)},o.prototype.handleChange=function(t,e,r,i){var a,n,d=this.props,u=d.store,h=d.formStore,l=d.onChange;typeof e=="string"&&((n=(a=u).changeValue)===null||n===void 0||n.call(a,e,t),h&&(l==null||l(t,e,r,i)))},o.prototype.renderBody=function(){var t=this.props,e=t.render,r=t.store,i=t.body,a=t.classnames;return e("body",r.schema||i,{key:r.schemaKey||"body",loading:r.loading,onQuery:this.handleQuery,onAction:this.handleAction,onChange:this.handleChange})},o.prototype.render=function(){var t=this.props,e=t.className,r=t.style,i=t.store,a=t.render,n=t.env,d=t.classPrefix,u=t.classnames,h=t.loadingConfig,l=t.showErrorMsg,p=t.testIdBuilder;return F().createElement("div",(0,s.pi)({className:u("".concat(d,"Service"),e),style:r},p==null?void 0:p.getTestId()),!n.forceSilenceInsideError&&i.error&&l!==!1?F().createElement(A.Vp1,{level:"danger",showCloseButton:!0,onClose:function(){return i.updateMessage("")}},i.msg):null,this.renderBody(),F().createElement(A.$jN,{size:"lg",overlay:!0,key:"info",show:i.loading,loadingConfig:h}),a("modal",(0,s.pi)((0,s.pi)({},i.action&&i.action.dialog),{type:"dialog"}),{key:"dialog",data:i.dialogData,onConfirm:this.handleDialogConfirm,onClose:this.handleDialogClose,show:i.dialogOpen}))},o.defaultProps={messages:{fetchFailed:"fetchFailed"},showErrorMsg:!0},o.propsList=[],(0,s.gn)([c.NjZ,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[]),(0,s.w6)("design:returntype",void 0)],o.prototype,"initFetch",null),(0,s.gn)([c.NjZ,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[Object]),(0,s.w6)("design:returntype",void 0)],o.prototype,"initDataProviders",null),(0,s.gn)([c.NjZ,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[Object,String]),(0,s.w6)("design:returntype",Object)],o.prototype,"normalizeProvider",null),(0,s.gn)([c.NjZ,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[Array,Object,Object,Array]),(0,s.w6)("design:returntype",void 0)],o.prototype,"handleDialogConfirm",null),(0,s.gn)([c.NjZ,(0,s.w6)("design:type",Function),(0,s.w6)("design:paramtypes",[Object]),(0,s.w6)("design:returntype",void 0)],o.prototype,"handleDialogClose",null),o}(F().Component),x=function(y){(0,s.ZT)(o,y);function o(t,e){var r=y.call(this,t)||this,i=e;return i.registerComponent(r),r}return o.prototype.reload=function(t,e,r,i,a){return(0,s.mG)(this,void 0,void 0,function(){var n;return(0,s.Jh)(this,function(d){return n=this.context,t?[2,n.reload(e?"".concat(t,"?").concat((0,c.mUA)(e)):t,r)]:[2,y.prototype.reload.call(this,t,e,r,i,a)]})})},o.prototype.receive=function(t,e,r){return(0,s.mG)(this,void 0,void 0,function(){var i;return(0,s.Jh)(this,function(a){return i=this.context,e?[2,i.send(e,t)]:[2,y.prototype.receive.call(this,t,e,r)]})})},o.prototype.componentWillUnmount=function(){y.prototype.componentWillUnmount.call(this);var t=this.context;t.unRegisterComponent(this)},o.prototype.reloadTarget=function(t,e){var r=this.context;r.reload(t,e)},o.prototype.setData=function(t,e){return this.props.store.updateData(t,void 0,e)},o.prototype.getData=function(){var t=this.props.store;return t.data},o.contextType=c.ZHe,o=(0,s.gn)([(0,c.Thl)({type:"service",storeType:c.Y5f.name,isolateScope:!0,storeExtendsData:function(t){return!t.formStore}}),(0,s.w6)("design:paramtypes",[Object,Object])],o),o}(C)}}]);
