# LogicRunnerService 核心特性说明

本文基于 `com.aims.logic.runtime.service.LogicRunnerService` 接口梳理逻辑编排运行时的核心能力，为后续设计覆盖性测试提供功能参考。

## 核心能力总览

| 能力域 | 关键方法 | 功能概述 |
| --- | --- | --- |
| 环境管理 | `setEnv` / `getEnvJson` / `getEnv` | 支持在运行期引入自定义环境变量，并可选择覆盖默认配置；既提供 JSON 视图，也提供强类型对象读取。 |
| 运行器实例化 | `newInstance(JSONObject)` / `newInstance(JSONObject, String, String, int, boolean)` | 允许基于特定环境克隆运行器实例，可传递父逻辑、父业务上下文及事务传播与异步标记，实现嵌套编排与上下游联动。 |
| 无状态逻辑执行 | `runByJson` / `runByObjectArgs` / `runByMap` | 以不同入参形态触发逻辑（JSON 字符串、顺序对象、Map），统一归一到 Map 形式执行；扩展重载可附带 `traceId`、`objectId` 与 `globalVars` 以增强观测与共享变量。 |
| 有状态业务执行 | `runBizByJson` / `runBizByObjectArgs` / `runBizByMap` | 在指定 `bizId` 下维护实例态，支持多种入参形态并可透传追踪信息及全局变量，覆盖长事务和调试场景。 |
| 异常与重试 | `retryErrorBiz` / `retryLongtimeRunningBiz` | 可对异常实例或超时运行业务进行自动恢复与批量补偿。 |
| 实例生命周期控制 | `forceCompleteBiz` / `forceStopBiz` / `resetBizInstanceNextId` / `updateBizInstanceParams` / `deleteBizInstance` / `deleteCompletedBizInstanceByLogicId` | 提供强制完成、终止、跳转节点、更新入参以及清理实例的精细化管理手段。 |
| 运维清理 | `clearLog` / `clearCompletedInstance` | 支持按需清理日志与已完成实例，维持运行环境整洁。 |
| 兼容接口 | `stopBiz` / `runBizByVerifyCode` / `queryLongtimeRunningBiz` / `queryUncompletedBiz` 等（标记 `@Deprecated`） | 保留历史接口用于过渡期兼容，覆盖验证码校验、运行中实例查询等传统场景。 |

## 详细特性解读

### 1. 运行环境管理
- `setEnv(JSONObject customEnv, boolean isOverride)`：在运行时注入自定义环境变量，可选择是否覆盖默认配置，实现多环境调试与动态参数化。
- `getEnvJson()` 与 `getEnv()`：分别提供 JSON 视图和强类型 `LogicSysEnvDto` 视图，兼顾动态配置和编译期类型安全。

### 2. 运行器实例化模式
- `newInstance(JSONObject env)`：基于当前运行器上下文复制新实例，并注入新的环境变量。
- `newInstance(JSONObject env, String parentLogicId, String parentBizId, int tranPropagation, boolean isAsync)`：在复制实例的同时传递父逻辑/业务标识，支持配置事务传播行为与异步模式，用于嵌套调用或子流程编排。

### 3. 无状态逻辑执行
- `runByJson` / `runByObjectArgs` 提供 JSON 字符串与顺序对象两种入口，最终统一转换为 `_p1`、`_p2`… 的参数 Map。
- `runByMap` 为核心执行入口，保留强类型；增强重载额外接收 `traceId`、`objectId` 和 `globalVars`，满足跨系统追踪与全局变量共享需求。

### 4. 有状态业务执行
- 所有 `runBiz*` 方法在普通执行基础上增加 `bizId`，用于跟踪业务实例状态。
- 支持 JSON、对象数组、Map 多形态入参，方便与不同调用端集成。
- 扩展重载可传递 `traceId`、`logicLogId`、`globalVars`，适配分布式追踪与调试日志对齐。

### 5. 异常恢复与补偿
- `retryErrorBiz`：针对执行异常实例，通过缓存恢复入参、临时变量与环境变量后重试。
- `retryLongtimeRunningBiz(int timeout)`：扫描并重试超过指定超时时间的长时间运行实例，实现自动补偿。

### 6. 实例生命周期治理
- `forceCompleteBiz` 与 `forceStopBiz`：提供强制完成与强制停机手段，可立即终止异常流程。
- `resetBizInstanceNextId`：重置待执行节点及局部变量，便于故障定位后从指定节点继续执行。
- `updateBizInstanceParams`：动态更新实例入参，支持在运行过程中注入修正数据。
- `deleteBizInstance`、`deleteCompletedBizInstanceByLogicId`：按需清理单个或某逻辑下全部完成实例。
- `clearCompletedInstance` 与 `clearLog`：面向运维的一键清理能力。

### 7. 兼容性与过渡接口
- `stopBiz`、`runBizByVerifyCode`、`queryLongtimeRunningBiz`、`queryUncompletedBiz` 等方法已标记 `@Deprecated`，用于兼容历史业务：
  - 验证码校验后执行逻辑。
  - 查询超时或未完成业务实例，包含按逻辑编号排除的筛选能力。
  - 逐步迁移至新接口的同时保证老流程仍可运行。

## 测试关注点建议
- 环境注入与覆盖策略生效校验（`setEnv` 与 `getEnv*`）。
- 多形态入参在无状态与有状态执行中的正确解析与统一落地。
- 异常/超时实例的重试机制与全局变量恢复。
- 实例生命周期操作（强制停止、重置下一节点、参数更新、清理）的幂等性与安全性。
- 兼容接口的废弃提示与功能保持。
