# LogicRunnerService 核心特性说明

本文基于 `com.aims.logic.runtime.service.LogicRunnerService` 接口梳理逻辑编排运行时的核心能力，为后续测试设计提供结构化的功能拆解视角。

## 核心功能域一览

| 功能域 | 关键职责 | 代表方法 | 典型测试思路 |
| --- | --- | --- | --- |
| 运行环境管理 | 接受外部环境参数并控制覆盖策略 | `setEnv` / `getEnvJson` / `getEnv` | 校验环境变量注入、合并与读取行为是否符合预期 |
| 运行器实例化与上下文继承 | 基于当前上下文复制运行器并继承父流程信息 | `newInstance(JSONObject)` / `newInstance(JSONObject, String, String, int, boolean)` | 验证新实例环境隔离、父逻辑/业务传递、事务传播与异步标记 |
| 无状态逻辑执行 | 对外暴露统一的无状态逻辑入口 | `runByJson` / `runByObjectArgs` / `runByMap`（含扩展重载） | 检查多形态入参归一为 Map 的逻辑、追踪信息透传及全局变量覆盖 |
| 有状态业务运行 | 维护带业务标识的长事务实例 | `runBizByJson` / `runBizByObjectArgs` / `runBizByMap`（含扩展重载） | 覆盖实例创建、状态持久化、追踪 ID 绑定及全局变量一致性 |
| 异常恢复与补偿 | 自动恢复异常或超时的实例 | `retryErrorBiz` / `retryLongtimeRunningBiz` | 验证异常重试时的上下文恢复与长耗时实例的超时判断 |
| 实例生命周期治理 | 提供手动干预实例执行的能力 | `forceCompleteBiz` / `forceStopBiz` / `resetBizInstanceNextId` / `updateBizInstanceParams` / `deleteBizInstance` / `deleteCompletedBizInstanceByLogicId` | 测试强制完成/停止、节点重置、参数更新和清理动作的幂等性与安全性 |
| 运维清理 | 维护运行环境整洁 | `clearLog` / `clearCompletedInstance` | 校验日志与实例清理的范围控制 |
| 兼容与废弃接口 | 保留历史能力供存量业务过渡 | `stopBiz` / `runBizByVerifyCode` / `queryLongtimeRunningBiz` / `queryUncompletedBiz` 等（`@Deprecated`） | 确认提示信息与基础功能仍可用，同时引导迁移 |

## 特性详解

### 1. 运行环境管理
- `setEnv(JSONObject customEnv, boolean isOverride)`: 支持在运行时注入自定义环境变量，可选择覆盖默认配置，实现多环境调试或动态参数化。
- `getEnvJson()` / `getEnv()`: 分别提供 JSON 视图与强类型 `LogicSysEnvDto` 视图，兼顾灵活配置和类型安全读取。

**测试要点**：
- 验证覆盖策略（覆盖/增量）是否正确执行。
- 确认强类型视图在缺失字段时的容错能力。

### 2. 运行器实例化与上下文继承
- `newInstance(JSONObject env)`: 基于当前运行器上下文复制新实例，并注入新的环境变量。
- `newInstance(JSONObject env, String parentLogicId, String parentBizId, int tranPropagation, boolean isAsync)`: 复制实例的同时维持父逻辑/业务链路，支持配置事务传播策略与异步标记，适合嵌套调用或子流程编排。

**测试要点**：
- 不同实例之间的环境变量隔离性。
- 父子流程信息是否完整传递，特别是事务与异步标记对执行路径的影响。

### 3. 无状态逻辑执行
- `runByJson` / `runByObjectArgs`: 接受 JSON 字符串或顺序对象参数，内部统一转换为 `_p1`、`_p2`… 的参数 Map。
- `runByMap`: 核心执行入口，保留强类型；重载版本可接受 `traceId`、`objectId` 与 `globalVars` 以增强分布式追踪和全局变量共享能力。

**测试要点**：
- 各种入参格式的转换正确性与顺序一致性。
- 追踪 ID、对象标识、全局变量的透传与合并策略。

### 4. 有状态业务运行
- 所有 `runBiz*` 方法在无状态执行的基础上增加 `bizId`，为长事务或多阶段流程提供实例化能力。
- 支持 JSON、对象数组、Map 多源入参，重载版本支持 `traceId`、`logicLogId`、`globalVars`。

**测试要点**：
- `bizId` 的唯一性与状态恢复。
- 多次调用同一实例的幂等性与上下文一致性。
- 日志与追踪信息在复杂流程中的对齐。

### 5. 异常恢复与补偿
- `retryErrorBiz`: 针对异常终止的实例，通过实例缓存恢复入参、临时变量和环境变量后重试。
- `retryLongtimeRunningBiz(int timeout)`: 批量扫描超过阈值的长耗时实例并触发补偿执行。

**测试要点**：
- 异常实例的上下文恢复完整性。
- 长时间运行判定的准确性以及多实例重试的隔离性。

### 6. 实例生命周期治理
- `forceCompleteBiz` / `forceStopBiz`: 提供强制完成或终止实例的手段，便于快速止损。
- `resetBizInstanceNextId`: 重置待执行节点和局部变量，支持从指定节点继续执行。
- `updateBizInstanceParams`: 在运行过程中动态调整实例入参。
- `deleteBizInstance` / `deleteCompletedBizInstanceByLogicId`: 精细化清理单实例或按逻辑维度清除已完成实例。

**测试要点**：
- 强制终止后的资源释放与状态标记是否正确。
- 节点重置与参数更新后再次执行的行为是否符合预期。
- 删除操作的范围与幂等性验证。

### 7. 运维清理能力
- `clearLog` / `clearCompletedInstance`: 提供运行环境快速清理的运维入口，用于定期维护或测试前置条件准备。

**测试要点**：
- 清理范围精准性（仅影响目标日志/实例）。
- 清理后对新实例或日志的写入不受影响。

### 8. 兼容与废弃接口
- `stopBiz`、`runBizByVerifyCode`、`queryLongtimeRunningBiz`、`queryUncompletedBiz`（及扩展）均标记为 `@Deprecated`，用于兼容历史业务场景：
  - 验证码校验后再执行业务。
  - 查询超时或未完成实例，并支持按逻辑编号排除。
- 虽逐步迁移至新接口，仍需保证现有存量流程可用。

**测试要点**：
- 兼容接口在受限场景下仍能正确返回数据或引发预期告警。
- 确认废弃标记和迁移建议对调用方可见。

## 测试设计参考清单
1. **环境策略测试**：覆盖覆盖模式、合并模式，以及读取强类型环境的边界值。
2. **实例化与调用链测试**：验证多层嵌套实例的父子关系、事务传播与异步标记对执行序列的影响。
3. **无状态执行多入参测试**：针对 JSON、对象数组、Map 三种形式设计参数映射与全局变量覆盖用例。
4. **有状态长事务测试**：模拟一次创建、多次调用、异常恢复的完整生命周期。
5. **异常/超时补偿测试**：构造故障与超时场景，验证重试是否准确恢复上下文并避免重复执行。
6. **生命周期操控测试**：分别验证强制完成、停止、节点重置、参数更新、删除操作的执行结果及重复调用表现。
7. **运维清理测试**：执行日志与实例清理后验证系统可继续创建新实例并生成日志。
8. **兼容接口回归测试**：确保 `@Deprecated` 方法在必要时仍保持行为一致，为迁移提供缓冲。
